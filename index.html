<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√©bergements Tourn√©e 2026</title>
    <style>
        /* Tous les styles CSS restent identiques */
        /* ... */
        
        /* Styles pour les dates cliquables */
        .date-clickable {
            cursor: pointer;
            color: #3498db;
            text-decoration: underline;
            transition: all 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .date-clickable:hover {
            background-color: #e8f4fd;
            color: #2980b9;
        }
        
        /* Styles pour les lieux et pays cliquables */
        .location-clickable {
            cursor: pointer;
            color: #27ae60;
            text-decoration: underline;
            transition: all 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .location-clickable:hover {
            background-color: #e8f5e8;
            color: #219653;
        }
        
        /* Styles pour les noms de personnes h√©berg√©es cliquables */
        .heberge-item-clickable {
            cursor: pointer;
            background: #ffc107;
            color: #856404;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
            white-space: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            text-decoration: underline;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .heberge-item-clickable:hover {
            background: #e0a800;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Style pour les noms d'h√¥tes cliquables dans le tableau */
        .hote-cell-clickable {
            cursor: pointer;
            color: #27ae60;
            text-decoration: underline;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .hote-cell-clickable:hover {
            color: #219653;
            background-color: #e8f5e8;
        }
        
        /* Styles pour le tableau des h√©bergeurs - MODIFI√â */
        .tableau-table th:nth-child(1),
        .tableau-table td:nth-child(1) {
            width: 25%;
            max-width: 150px;
            min-width: 100px;
            font-size: 13px;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .tableau-table th:nth-child(2),
        .tableau-table td:nth-child(2) {
            width: 15%;
            max-width: 80px;
            min-width: 70px;
            font-size: 13px;
        }
        
        .tableau-table th:nth-child(3),
        .tableau-table td:nth-child(3) {
            width: 15%;
            max-width: 90px;
            min-width: 80px;
            font-size: 13px;
        }
        
        .tableau-table th:nth-child(4),
        .tableau-table td:nth-child(4) {
            width: 20%;
            max-width: 120px;
            min-width: 100px;
            font-size: 12px;
            white-space: normal;
            line-height: 1.3;
        }
        
        .tableau-table th:nth-child(5),
        .tableau-table td:nth-child(5) {
            width: 10%;
            max-width: 70px;
            min-width: 60px;
            font-size: 13px;
            text-align: center;
        }
        
        .tableau-table th:nth-child(6),
        .tableau-table td:nth-child(6) {
            width: 15%;
            max-width: 150px;
            min-width: 120px;
            font-size: 12px;
        }
        
        /* Autres styles restent identiques */
        /* ... */
    </style>
</head>
<body>
    <!-- Boutons de navigation fixes avec bouton email -->
    <div class="fixed-nav-buttons">
        <button class="icon-button home" id="homeButton" title="Accueil">
            üè†
        </button>
        <button class="icon-button list" id="showAllDataButton" title="Toutes les donn√©es">
            üìã
        </button>
        <button class="icon-button calendar-btn" id="scrollToCalendarButton" title="Aller au calendrier">
            üìÖ
        </button>
        <button class="icon-button email-btn disabled" id="sendEmailsButton" title="Envoyer un email de remerciements (verrouill√©)">
            üìß
        </button>
        <button class="icon-button export locked" id="exportDataButton" title="Exporter les donn√©es (verrouill√©)">
            üì§
        </button>
    </div>

    <div class="container">
        <header>
            <div class="decoration-images-left">
                <span>üèòÔ∏è</span>
                <span>üè†</span>
                <span>üè®</span>
            </div>
            <div class="decoration-images">
                <span>üõå</span>
                <span>üè°</span>
                <span>üö™</span>
            </div>
            <div class="header-overlay">
                <div class="header-left">
                    <h1>H√©bergements Tourn√©e 2026</h1>
                    <p>Consultation des h√©bergements par date et par h√¥te</p>
                </div>
                <div class="header-search">
                    <input type="date" id="dateInput" class="search-input">
                    <button class="search-icon-button" id="searchButton" title="Rechercher par date">
                        üîç
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Sidebar gauche avec boutons d'action et filtres -->
        <div class="sidebar">
            <div class="stats-section">
                <h3 style="margin-bottom: 15px; color: var(--secondary-color); text-align: center;">üìä Statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalHebergements">0</div>
                        <div class="stat-label">H√©bergements total</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalHotes">0</div>
                        <div class="stat-label">H√¥tes diff√©rents</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalPays">0</div>
                        <div class="stat-label">Pays diff√©rents</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalLieux">0</div>
                        <div class="stat-label">Lieux diff√©rents</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalHeberges">0</div>
                        <div class="stat-label">Personnes h√©berg√©es</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('Famille')">
                        <div class="stat-value" id="totalFamille">0</div>
                        <div class="stat-label">H√©bergements en Famille</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('H√¥tel')">
                        <div class="stat-value" id="totalHotel">0</div>
                        <div class="stat-label">H√©bergements en H√¥tel</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('Centre')">
                        <div class="stat-value" id="totalCentre">0</div>
                        <div class="stat-label">H√©bergements en Centre</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('Autre')">
                        <div class="stat-value" id="totalAutre">0</div>
                        <div class="stat-label">Autres h√©bergements</div>
                    </div>
                </div>
            </div>
            
            <!-- Boutons d'action lat√©raux (visible sur desktop) -->
            <div class="action-buttons-sidebar">
                <button id="showAllButton" class="action-button">
                    üìã Afficher tous les h√©bergements
                </button>
                
                <button id="showTableauButton" class="action-button" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                    üìä Tableau des h√©bergeurs
                </button>
                
                <button id="showPrieresButton" class="action-button priere">
                    üôè Afficher les sujets de pri√®re
                </button>
            </div>
            
            <!-- Filtres dans la sidebar -->
            <div class="filters-sidebar">
                <div class="filter-group">
                    <h3 class="toggle-title" data-filter="hotes">
                        <span style="color: #3498db;">üë§ H√¥tes</span>
                        <span class="toggle-indicator">‚ñ∂ Cliquer pour afficher</span>
                    </h3>
                    <div class="filter-tags" id="hotesTags" style="display: none;">
                        <!-- Les h√¥tes seront g√©n√©r√©s ici -->
                    </div>
                </div>
                
                <div class="filter-group">
                    <h3 class="toggle-title" data-filter="pays">
                        <span style="color: #27ae60;">üåç Pays</span>
                        <span class="toggle-indicator">‚ñ∂ Cliquer pour afficher</span>
                    </h3>
                    <div class="filter-tags" id="paysTags" style="display: none;">
                        <!-- Les pays seront g√©n√©r√©s ici -->
                    </div>
                </div>
                
                <div class="filter-group">
                    <h3 class="toggle-title" data-filter="lieux">
                        <span style="color: #9b59b6;">üìç Lieux</span>
                        <span class="toggle-indicator">‚ñ∂ Cliquer pour afficher</span>
                    </h3>
                    <div class="filter-tags" id="lieuxTags" style="display: none;">
                        <!-- Les lieux seront g√©n√©r√©s ici -->
                    </div>
                </div>
                
                <div class="filter-group">
                    <h3 class="toggle-title" data-filter="heberges">
                        <span style="color: #f39c12;">üë• Personnes h√©berg√©es</span>
                        <span class="toggle-indicator">‚ñ∂ Cliquer pour afficher</span>
                    </h3>
                    <div class="filter-tags" id="hebergesTags" style="display: none;">
                        <!-- Les personnes h√©berg√©es seront g√©n√©r√©s ici -->
                    </div>
                </div>
                
                <div class="filter-group">
                    <h3 class="toggle-title" data-filter="types">
                        <span style="color: #2196F3;">üè† Types d'h√©bergement</span>
                        <span class="toggle-indicator">‚ñ∂ Cliquer pour afficher</span>
                    </h3>
                    <div class="filter-tags" id="typesTags" style="display: none;">
                        <!-- Les types d'h√©bergement seront g√©n√©r√©s ici -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contenu principal -->
        <div class="main-content">
            <!-- Statistiques en haut sur mobile SEULEMENT -->
            <div class="stats-section mobile-stats">
                <h3 style="margin-bottom: 15px; color: var(--secondary-color); text-align: center;">üìä Statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalHebergementsMobile">0</div>
                        <div class="stat-label">H√©bergements total</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalHotesMobile">0</div>
                        <div class="stat-label">H√¥tes diff√©rents</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalPaysMobile">0</div>
                        <div class="stat-label">Pays diff√©rents</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalLieuxMobile">0</div>
                        <div class="stat-label">Lieux diff√©rents</div>
                    </div>
                    <div class="stat-card" onclick="showAllData()">
                        <div class="stat-value" id="totalHebergesMobile">0</div>
                        <div class="stat-label">Personnes h√©berg√©es</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('Famille')">
                        <div class="stat-value" id="totalFamilleMobile">0</div>
                        <div class="stat-label">Famille</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('H√¥tel')">
                        <div class="stat-value" id="totalHotelMobile">0</div>
                        <div class="stat-label">H√¥tel</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('Centre')">
                        <div class="stat-value" id="totalCentreMobile">0</div>
                        <div class="stat-label">Centre</div>
                    </div>
                    <div class="stat-card" onclick="filterByType('Autre')">
                        <div class="stat-value" id="totalAutreMobile">0</div>
                        <div class="stat-label">Autres</div>
                    </div>
                </div>
            </div>
            
            <!-- Boutons d'action mobile (visible uniquement sur mobile) -->
            <div class="action-buttons-mobile">
                <button id="showAllButtonMobile" class="action-button-mobile">
                    üìã Tous
                </button>
                
                <button id="showTableauButtonMobile" class="action-button-mobile tableau">
                    üìä Tableau
                </button>
                
                <button id="showPrieresButtonMobile" class="action-button-mobile priere">
                    üôè Pri√®res
                </button>
            </div>
            
            <!-- Filtres mobiles avec afficher/masquer -->
            <div class="mobile-filters">
                <div class="mobile-filter-group">
                    <div class="mobile-filter-header" data-filter="hotes">
                        <div class="mobile-filter-title hotes">
                            <span>üë§</span>
                            <span>H√¥tes</span>
                        </div>
                        <div class="mobile-filter-toggle collapsed"></div>
                    </div>
                    <div class="mobile-filter-content" id="mobileHotesContent">
                        <div class="mobile-tags-container" id="mobileHotesTags">
                            <!-- Les h√¥tes seront g√©n√©r√©s ici -->
                        </div>
                    </div>
                </div>
                
                <div class="mobile-filter-group">
                    <div class="mobile-filter-header" data-filter="pays">
                        <div class="mobile-filter-title pays">
                            <span>üåç</span>
                            <span>Pays</span>
                        </div>
                        <div class="mobile-filter-toggle collapsed"></div>
                    </div>
                    <div class="mobile-filter-content" id="mobilePaysContent">
                        <div class="mobile-tags-container" id="mobilePaysTags">
                            <!-- Les pays seront g√©n√©r√©s ici -->
                        </div>
                    </div>
                </div>
                
                <div class="mobile-filter-group">
                    <div class="mobile-filter-header" data-filter="lieux">
                        <div class="mobile-filter-title lieux">
                            <span>üìç</span>
                            <span>Lieux</span>
                        </div>
                        <div class="mobile-filter-toggle collapsed"></div>
                    </div>
                    <div class="mobile-filter-content" id="mobileLieuxContent">
                        <div class="mobile-tags-container" id="mobileLieuxTags">
                            <!-- Les lieux seront g√©n√©r√©s ici -->
                        </div>
                    </div>
                </div>
                
                <div class="mobile-filter-group">
                    <div class="mobile-filter-header" data-filter="heberges">
                        <div class="mobile-filter-title heberges">
                            <span>üë•</span>
                            <span>Personnes h√©berg√©es</span>
                        </div>
                        <div class="mobile-filter-toggle collapsed"></div>
                    </div>
                    <div class="mobile-filter-content" id="mobileHebergesContent">
                        <div class="mobile-tags-container" id="mobileHebergesTags">
                            <!-- Les personnes h√©berg√©es seront g√©n√©r√©s ici -->
                        </div>
                    </div>
                </div>
                
                <div class="mobile-filter-group">
                    <div class="mobile-filter-header" data-filter="types">
                        <div class="mobile-filter-title types">
                            <span>üè†</span>
                            <span>Types d'h√©bergement</span>
                        </div>
                        <div class="mobile-filter-toggle collapsed"></div>
                    </div>
                    <div class="mobile-filter-content" id="mobileTypesContent">
                        <div class="mobile-tags-container" id="mobileTypesTags">
                            <!-- Les types d'h√©bergement seront g√©n√©r√©s ici -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="calendar-section">
                <div class="calendar-header">
                    <h3>üìÖ Calendrier des h√©bergements</h3>
                    <div class="calendar-nav">
                        <button id="prevMonth">‚óÄ</button>
                        <span id="currentMonth">Mois en cours</span>
                        <button id="nextMonth">‚ñ∂</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Le calendrier sera g√©n√©r√© ici -->
                </div>
            </div>
            
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Chargement des donn√©es depuis Google Sheets...</p>
            </div>

            <div id="dataInfo" class="data-info"></div>
            
            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="result-header">
                    <h2 id="resultTitle">R√©sultats de la recherche</h2>
                    <button id="closeResults" style="background: none; border: none; color: white; font-size: 1.2em; cursor: pointer;">‚úï Fermer</button>
                </div>
                <div class="result-content" id="resultContent">
                    <!-- Les r√©sultats seront affich√©s ici -->
                </div>
            </section>
            
            <!-- Section pour le tableau des h√©bergeurs -->
            <div class="tableau-container" id="tableauSection" style="display: none;">
                <div class="tableau-header">
                    <h2 id="tableauTitle">üìä Tableau des h√©bergeurs</h2>
                </div>
                <div class="tableau-content">
                    <div class="tableau-export-buttons">
                        <button class="tableau-export-button pdf" id="exportTableauPDF">
                            üìÑ Exporter en PDF
                        </button>
                        <button class="tableau-export-button excel" id="exportTableauExcel">
                            üìä Exporter en Excel
                        </button>
                    </div>
                    <div id="tableauContent">
                        <!-- Le tableau sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulle d'options pour les personnes h√©berg√©es -->
    <div id="personOptionsBubble" class="options-bubble person-bubble">
        <div class="option-item" id="showPersonFiches">
            <span class="option-icon">üìÑ</span>
            <span class="option-label">Voir toutes les fiches</span>
        </div>
        <div class="option-item" id="showPersonHotes">
            <span class="option-icon">üë§</span>
            <span class="option-label">Afficher la liste des h√¥tes + pays</span>
        </div>
    </div>

    <!-- Modale pour l'exportation -->
    <div id="exportModal" class="export-modal">
        <div class="export-modal-content">
            <h3 style="margin-bottom: 20px; color: var(--secondary-color);">üì§ Exporter les donn√©es</h3>
            
            <div class="export-options">
                <div class="export-type" id="exportType1">
                    <div class="export-type-title">
                        <span>üìã</span>
                        <span>Liste de tous les h√©bergeurs</span>
                    </div>
                    <div class="export-type-description">
                        Exporte tous les h√©bergeurs avec leurs informations compl√®tes (nom, coordonn√©es, adresse, etc.)
                    </div>
                </div>
                
                <div class="export-type" id="exportType2">
                    <div class="export-type-title">
                        <span>üåç</span>
                        <span>Liste par pays des h√©bergeurs</span>
                    </div>
                    <div class="export-type-description">
                        Exporte les h√©bergeurs organis√©s par pays avec leurs informations de contact
                    </div>
                </div>
                
                <div class="export-type" id="exportType3">
                    <div class="export-type-title">
                        <span>üìÑ</span>
                        <span>Fiches d√©taill√©es par h√©bergement</span>
                    </div>
                    <div class="export-type-description">
                        Exporte toutes les fiches d√©taill√©es de chaque h√©bergement (format PDF)
                    </div>
                </div>
                
                <div class="export-type" id="exportType4">
                    <div class="export-type-title">
                        <span>üìä</span>
                        <span>Tableau des h√©bergeurs</span>
                    </div>
                    <div class="export-type-description">
                        Exporte le tableau complet des h√©bergeurs avec h√¥te, pays, lieu, dates, dur√©e et h√©berg√©s
                    </div>
                </div>
            </div>
            
            <div class="export-format-options" id="formatOptions" style="display: none;">
                <div class="format-option" data-format="csv">CSV</div>
                <div class="format-option" data-format="excel">Excel</div>
                <div class="format-option" data-format="pdf">PDF</div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button id="cancelExport" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Annuler
                </button>
                <button id="confirmExport" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; display: none;">
                    üì§ Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Modale pour le mot de passe admin -->
    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <h3 style="margin-bottom: 20px; color: var(--secondary-color);">üîê Acc√®s administrateur requis</h3>
            
            <p style="margin-bottom: 15px;">Veuillez entrer le mot de passe pour acc√©der aux fonctions admin :</p>
            
            <input type="password" id="adminPassword" class="password-input" placeholder="Mot de passe" autocomplete="off">
            
            <div id="passwordError" style="color: #e74c3c; margin-bottom: 15px; display: none;">
                ‚ùå Mot de passe incorrect
            </div>
            
            <div class="password-buttons">
                <button id="cancelPassword" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Annuler
                </button>
                <button id="submitPassword" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Valider
                </button>
            </div>
        </div>
    </div>

    <!-- Modale pour l'envoi d'emails -->
    <div id="emailModal" class="email-modal">
        <div class="email-modal-content">
            <h3 style="margin-bottom: 20px; color: var(--secondary-color);">üìß Envoi d'email de remerciements</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Destinataires avec email:</label>
                <div id="emailRecipients" class="email-recipients">
                    <!-- Liste des destinataires g√©n√©r√©e ici -->
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <span id="recipientCount">0</span> destinataire(s) s√©lectionn√©(s)
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Sujet:</label>
                <input type="text" id="emailSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                       value="Remerciements pour votre hospitalit√© - Tourn√©e 2026">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Message:</label>
                <textarea id="emailMessage" style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;">Cher/ch√®re [Nom],

Nous tenons √† vous remercier chaleureusement pour votre g√©n√©reux accueil et votre hospitalit√© durant notre tourn√©e 2026. Votre soutien a √©t√© pr√©cieux pour nous.

Nous gardons un excellent souvenir de notre s√©jour chez vous et esp√©rons avoir l'occasion de vous revoir bient√¥t.

Avec toute notre gratitude,

L'√©quipe de la Tourn√©e 2026</textarea>
            </div>

            <div class="upload-section">
                <h4 style="margin-bottom: 15px; color: #3498db;">üì∏ Ajouter des photos √† l'email</h4>
                
                <div class="upload-area">
                    <input type="file" id="photoUpload" multiple accept="image/*" style="display: none;">
                    <button type="button" id="uploadButton" class="upload-button">
                        üìÅ Choisir des photos
                    </button>
                    <div class="upload-instructions">
                        Formats accept√©s: JPG, PNG, GIF (max 5MB par photo)
                    </div>
                </div>
                
                <div id="photosPreview" class="photos-preview">
                    <!-- Aper√ßu des photos upload√©es -->
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                <button id="cancelEmail" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">Annuler</button>
                <button id="copyEmails" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">üìã Copier les adresses</button>
                <button id="sendEmails" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">üìß Envoyer les emails</button>
            </div>
        </div>
    </div>

    <script>
        // URL de la feuille Google Sheets pour les h√©bergements
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXIJyclDLf2asT-FMnmaeWMSPtQHxpAC1wiGJ_xzXbl2StziwiUw9ElW9XyK5yemQ-PHaWlRQbtdHb/pub?gid=1650312054&single=true&output=csv';
        
        // Mot de passe admin
        const ADMIN_PASSWORD = "admin";
        
        let sheetData = [];
        let headers = [];
        // Commencer le calendrier au mois en cours
        let currentDate = new Date(); // Mois en cours
        let selectedDate = null;
        let allHotes = [];
        let allPays = [];
        let allLieux = [];
        let allHeberges = new Set();
        let allPrieres = [];
        let bookingPeriods = [];
        let uploadedPhotos = []; // Stocker les photos upload√©es
        let isAdmin = false; // √âtat d'authentification admin
        let selectedExportType = null;
        let selectedExportFormat = null;
        let passwordModalAction = null; // 'export' ou 'email' selon l'action demand√©e
        
        // Variables pour la bulle d'options
        let currentSelectedPerson = null;
        let currentClickedPersonElement = null;
        
        // Variable pour stocker les donn√©es du tableau des h√©bergeurs
        let tableauData = [];

        // Index des colonnes (√† d√©tecter automatiquement)
        let colDateDebut = -1;
        let colDateFin = -1;
        let colNom = -1;
        let colPays = -1;
        let colLieu = -1;
        let colAdresse = -1;
        let colEmail = -1;
        let colFacebook = -1;
        let colTelephone = -1;
        let colMpihiraLehilahy = -1;
        let colMpitendry = -1;
        let colFeo1 = -1;
        let colFeo2 = -1;
        let colPriere = -1;
        let colMarquants = -1;
        let colPhotosHotes = -1;
        let colPhotosLieux = -1;
        let colFormulaire = -1;
        let colRepartition = -1;
        let colHebergeEn = -1;

        // Colonnes pour les informations suppl√©mentaires
        let colAdresseHebergeur = -1;
        let colLieuHebergeur = -1;
        let colPaysHebergeur = -1;
        let colNumeroHebergeur = -1;
        let colASavoirHote = -1;

        // Variables pour les statistiques des types d'h√©bergement
        let typeFamille = 0;
        let typeHotel = 0;
        let typeCentre = 0;
        let typeAutre = 0;
        let allTypes = new Set();

        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les boutons de navigation fixes
            document.getElementById('homeButton').addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('tableauSection').style.display = 'none';
                hidePersonBubble();
            });
            
            document.getElementById('scrollToCalendarButton').addEventListener('click', function() {
                document.querySelector('.calendar-section').scrollIntoView({ behavior: 'smooth' });
                hidePersonBubble();
            });
            
            document.getElementById('showAllDataButton').addEventListener('click', showAllData);
            
            // Bouton email dans les boutons fixes - CORRIG√â
            document.getElementById('sendEmailsButton').addEventListener('click', function() {
                if (this.classList.contains('disabled')) {
                    passwordModalAction = 'email';
                    showPasswordModal();
                } else {
                    showEmailModal();
                }
            });
            
            // Bouton export dans les boutons fixes - CORRIG√â
            document.getElementById('exportDataButton').addEventListener('click', function() {
                if (this.classList.contains('locked')) {
                    passwordModalAction = 'export';
                    showPasswordModal();
                } else {
                    showExportModal();
                }
            });
            
            // Recherche
            document.getElementById('searchButton').addEventListener('click', handleSearch);
            document.getElementById('dateInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // Boutons d'action desktop
            document.getElementById('showAllButton').addEventListener('click', showAllData);
            document.getElementById('showTableauButton').addEventListener('click', showTableauHebergeurs);
            document.getElementById('showPrieresButton').addEventListener('click', showPrieres);
            
            // Boutons d'action mobile
            document.getElementById('showAllButtonMobile').addEventListener('click', showAllData);
            document.getElementById('showTableauButtonMobile').addEventListener('click', showTableauHebergeurs);
            document.getElementById('showPrieresButtonMobile').addEventListener('click', showPrieres);
            
            document.getElementById('closeResults').addEventListener('click', closeResults);
            
            // Navigation du calendrier
            document.getElementById('prevMonth').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
                hidePersonBubble();
            });
            
            document.getElementById('nextMonth').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
                hidePersonBubble();
            });
            
            // √âv√©nements pour la modale d'exportation
            document.getElementById('cancelExport').addEventListener('click', function() {
                document.getElementById('exportModal').style.display = 'none';
                resetExportModal();
            });
            
            document.getElementById('confirmExport').addEventListener('click', exportData);
            
            // S√©lection du type d'export
            document.getElementById('exportType1').addEventListener('click', function() {
                selectExportType(1);
            });
            
            document.getElementById('exportType2').addEventListener('click', function() {
                selectExportType(2);
            });
            
            document.getElementById('exportType3').addEventListener('click', function() {
                selectExportType(3);
            });
            
            document.getElementById('exportType4').addEventListener('click', function() {
                selectExportType(4);
            });
            
            // S√©lection du format d'export
            document.querySelectorAll('.format-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.format-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedExportFormat = this.getAttribute('data-format');
                    document.getElementById('confirmExport').style.display = 'block';
                });
            });
            
            // √âv√©nements pour la modale de mot de passe - CORRIG√â
            document.getElementById('cancelPassword').addEventListener('click', function() {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('adminPassword').value = '';
                document.getElementById('passwordError').style.display = 'none';
                passwordModalAction = null;
            });
            
            document.getElementById('submitPassword').addEventListener('click', function() {
                const password = document.getElementById('adminPassword').value;
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    // D√©verrouiller les boutons admin
                    document.getElementById('exportDataButton').classList.remove('locked');
                    document.getElementById('exportDataButton').title = "Exporter les donn√©es";
                    document.getElementById('sendEmailsButton').classList.remove('disabled');
                    document.getElementById('sendEmailsButton').title = "Envoyer un email de remerciements";
                    
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('passwordError').style.display = 'none';
                    
                    // Ex√©cuter l'action demand√©e apr√®s authentification
                    if (passwordModalAction === 'export') {
                        showExportModal();
                    } else if (passwordModalAction === 'email') {
                        showEmailModal();
                    }
                    
                    passwordModalAction = null;
                } else {
                    document.getElementById('passwordError').style.display = 'block';
                    document.getElementById('adminPassword').value = '';
                }
            });
            
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('submitPassword').click();
                }
            });
            
            // √âv√©nements pour la modale d'email
            document.getElementById('cancelEmail').addEventListener('click', function() {
                document.getElementById('emailModal').style.display = 'none';
                clearUploadedPhotos();
            });
            
            document.getElementById('sendEmails').addEventListener('click', sendEmails);
            document.getElementById('copyEmails').addEventListener('click', copyEmailAddresses);
            
            // √âv√©nements pour l'upload de photos
            document.getElementById('uploadButton').addEventListener('click', function() {
                document.getElementById('photoUpload').click();
            });
            
            document.getElementById('photoUpload').addEventListener('change', handlePhotoUpload);
            
            // √âv√©nements pour la bulle d'options des personnes h√©berg√©es
            document.getElementById('showPersonFiches').addEventListener('click', function() {
                if (currentSelectedPerson) {
                    const results = filterByHeberge(currentSelectedPerson);
                    displayResults(results, `Fiches pour: ${currentSelectedPerson}`);
                    hidePersonBubble();
                }
            });
            
            document.getElementById('showPersonHotes').addEventListener('click', function() {
                if (currentSelectedPerson) {
                    showHotesForPerson(currentSelectedPerson);
                    hidePersonBubble();
                }
            });
            
            // √âv√©nements pour les filtres mobiles (afficher/masquer)
            document.querySelectorAll('.mobile-filter-header').forEach(header => {
                header.addEventListener('click', function() {
                    const filterType = this.getAttribute('data-filter');
                    const content = document.getElementById(`mobile${filterType.charAt(0).toUpperCase() + filterType.slice(1)}Content`);
                    const toggle = this.querySelector('.mobile-filter-toggle');
                    
                    if (content.classList.contains('open')) {
                        content.classList.remove('open');
                        toggle.classList.remove('expanded');
                        toggle.classList.add('collapsed');
                    } else {
                        content.classList.add('open');
                        toggle.classList.remove('collapsed');
                        toggle.classList.add('expanded');
                    }
                });
            });
            
            // √âv√©nements pour les filtres desktop (afficher/masquer)
            document.querySelectorAll('.toggle-title').forEach(title => {
                title.addEventListener('click', function() {
                    const filterType = this.getAttribute('data-filter');
                    const container = document.getElementById(`${filterType}Tags`);
                    const indicator = this.querySelector('.toggle-indicator');
                    
                    if (container.style.display === 'none' || container.style.display === '') {
                        container.style.display = 'flex';
                        indicator.textContent = '‚ñº R√©duire';
                    } else {
                        container.style.display = 'none';
                        indicator.textContent = '‚ñ∂ Cliquer pour afficher';
                    }
                });
            });
            
            // Cacher la bulle quand on clique ailleurs
            document.addEventListener('click', function(event) {
                const personBubble = document.getElementById('personOptionsBubble');
                
                if (!event.target.closest('.heberge-tag') && !event.target.closest('#personOptionsBubble') && 
                    !event.target.closest('.tag.heberge') && !event.target.closest('#personOptionsBubble') &&
                    !event.target.closest('.mobile-tag.heberge')) {
                    if (personBubble.style.display === 'flex') {
                        hidePersonBubble();
                    }
                }
            });
            
            // Boutons d'export du tableau
            document.getElementById('exportTableauPDF').addEventListener('click', function() {
                exportTableau('pdf');
            });
            
            document.getElementById('exportTableauExcel').addEventListener('click', function() {
                exportTableau('excel');
            });
            
            // Charger les donn√©es
            loadDataFromGoogleSheets();
        });

        // Fonction pour filtrer par type d'h√©bergement
        function filterByType(type) {
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            let results = [];
            
            if (type === 'Famille' || type === 'H√¥tel' || type === 'Centre') {
                // Pour les types principaux, on cherche dans "Heberg√© en"
                results = sheetData.filter(row => {
                    if (colHebergeEn !== -1) {
                        const typeValue = (row[colHebergeEn] || '').trim().toLowerCase();
                        const searchType = type.toLowerCase();
                        
                        if (searchType === 'famille' && typeValue.includes('famille')) {
                            return true;
                        } else if (searchType === 'h√¥tel' && (typeValue.includes('hotel') || typeValue.includes('h√¥tel'))) {
                            return true;
                        } else if (searchType === 'centre' && typeValue.includes('centre')) {
                            return true;
                        }
                    }
                    return false;
                });
            } else if (type === 'Autre') {
                // Pour "Autre", on prend tous ceux qui ne sont pas Famille, H√¥tel ou Centre
                results = sheetData.filter(row => {
                    if (colHebergeEn !== -1) {
                        const typeValue = (row[colHebergeEn] || '').trim().toLowerCase();
                        return typeValue !== '' && 
                               !typeValue.includes('famille') && 
                               !typeValue.includes('hotel') && 
                               !typeValue.includes('h√¥tel') && 
                               !typeValue.includes('centre');
                    }
                    return false;
                });
            }
            
            if (results.length > 0) {
                displayResults(results, `H√©bergements en ${type} (${results.length})`);
            } else {
                alert(`Aucun h√©bergement trouv√© pour le type: ${type}`);
            }
        }

        // Fonction pour afficher le tableau des h√©bergeurs
        function showTableauHebergeurs() {
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            // Cacher la section des r√©sultats
            document.getElementById('resultsSection').style.display = 'none';
            
            // Afficher la section du tableau
            const tableauSection = document.getElementById('tableauSection');
            const tableauContent = document.getElementById('tableauContent');
            
            // G√©n√©rer les donn√©es du tableau
            generateTableauData();
            
            // Cr√©er le HTML du tableau
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 5px;">
                    <strong>${tableauData.length} h√©bergeur(s) trouv√©(s)</strong>
                    <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                        Total des s√©jours: ${tableauData.reduce((sum, hote) => sum + hote.sejours, 0)} |
                        Total des jours: ${tableauData.reduce((sum, hote) => sum + hote.jours, 0)} |
                        Total des nuit√©es: ${tableauData.reduce((sum, hote) => sum + hote.nuits, 0)}
                    </div>
                </div>
                
                <table class="tableau-table">
                    <thead>
                        <tr>
                            <th>H√¥te</th>
                            <th>Pays</th>
                            <th>Lieu</th>
                            <th>Dates</th>
                            <th>Dur√©e</th>
                            <th>Personnes h√©berg√©es</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            tableauData.forEach(hote => {
                // Rendre les dates cliquables dans le tableau
                const datesHtml = hote.dates.map(date => {
                    // Extraire la date de d√©but pour le filtrage
                    const dateMatch = date.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                    if (dateMatch) {
                        const dateStr = dateMatch[1];
                        return `<div class="date-clickable" onclick="searchByDateString('${dateStr}')">${date}</div>`;
                    }
                    return `<div>${date}</div>`;
                }).join('');
                
                // Rendre le nom de l'h√¥te cliquable
                const hoteNomHtml = `<span class="hote-cell-clickable" onclick="showFichesForHote('${hote.nom.replace(/'/g, "\\'")}')">${hote.nom}</span>`;
                
                // Rendre le pays cliquable
                const paysHtml = `<span class="location-clickable" onclick="filterByLocation('${hote.pays.replace(/'/g, "\\'")}', 'pays')">${hote.pays}</span>`;
                
                // Rendre le lieu cliquable
                const lieuHtml = `<span class="location-clickable" onclick="filterByLocation('${hote.lieu.replace(/'/g, "\\'")}', 'lieu')">${hote.lieu}</span>`;
                
                // Rendre les personnes h√©berg√©es cliquables
                const personnesHtml = hote.personnes.map(p => 
                    `<span class="heberge-item-clickable" onclick="showPersonOptionsForHeberge(event, '${p.replace(/'/g, "\\'")}')">${p}</span>`
                ).join('');
                
                html += `
                    <tr>
                        <td>${hoteNomHtml}</td>
                        <td>${paysHtml}</td>
                        <td>${lieuHtml}</td>
                        <td>${datesHtml}</td>
                        <td class="duration-cell">
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <span style="display: inline-block; padding: 3px 6px; background: #ffc107; color: #856404; border-radius: 8px; font-weight: bold; font-size: 0.9em;">
                                        ${hote.jours} j
                                    </span>
                                    <span style="display: inline-block; padding: 3px 6px; background: #17a2b8; color: white; border-radius: 8px; font-weight: bold; font-size: 0.9em; margin-top: 3px;">
                                        ${hote.nuits} n
                                    </span>
                                </div>
                                <div style="font-size: 0.8em; color: #6c757d; margin-top: 3px;">
                                    (${hote.sejours})
                                </div>
                            </div>
                        </td>
                        <td class="heberge-list-cell">
                            <div style="display: flex; flex-wrap: wrap; gap: 2px; max-height: 80px; overflow-y: auto; padding: 3px;">
                                ${personnesHtml}
                            </div>
                            <div style="font-size: 0.8em; color: #666; margin-top: 3px;">
                                ${hote.personnes.length} p
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            tableauContent.innerHTML = html;
            tableauSection.style.display = 'block';
            
            // Faire d√©filer jusqu'au tableau
            tableauSection.scrollIntoView({ behavior: 'smooth' });
            
            hidePersonBubble();
        }
        
        // Fonction pour rechercher par cha√Æne de date (utilis√©e pour les dates cliquables dans le tableau)
        function searchByDateString(dateStr) {
            const date = parseDate(dateStr);
            if (date) {
                searchByDate(date);
            } else {
                alert('Date non valide: ' + dateStr);
            }
        }
        
        // Fonction pour filtrer par lieu ou pays (utilis√©e pour les lieux/pays cliquables)
        function filterByLocation(value, type) {
            const results = filterDataByType(value, type);
            displayResults(results, `${type === 'pays' ? 'Pays' : 'Lieu'}: ${value}`);
        }
        
        // Fonction pour afficher les fiches d'un h√¥te sp√©cifique
        function showFichesForHote(hoteNom) {
            const results = filterDataByType(hoteNom, 'nom');
            displayResults(results, `Fiches pour l'h√¥te: ${hoteNom}`);
        }
        
        // Fonction pour afficher les options d'une personne h√©berg√©e dans le tableau
        function showPersonOptionsForHeberge(event, personName) {
            event.stopPropagation();
            event.preventDefault();
            showPersonOptionsBubble(event.target, personName);
        }
        
        // Fonction pour g√©n√©rer les donn√©es du tableau
        function generateTableauData() {
            const hotesMap = new Map();
            
            sheetData.forEach((row, index) => {
                const dateDebut = colDateDebut !== -1 ? row[colDateDebut] : '';
                const dateFin = colDateFin !== -1 ? row[colDateFin] : '';
                const nom = colNom !== -1 ? row[colNom] : '';
                const pays = colPays !== -1 ? row[colPays] : '';
                const lieu = colLieu !== -1 ? row[colLieu] : '';
                
                if (nom && nom.trim()) {
                    const key = nom.trim().toLowerCase();
                    const paysValue = pays ? pays.trim() : 'Non sp√©cifi√©';
                    const lieuValue = lieu ? lieu.trim() : 'Non sp√©cifi√©';
                    const dateDebutObj = parseDate(dateDebut);
                    const dateFinObj = parseDate(dateFin);
                    
                    let dateString = '';
                    if (dateDebut && dateFin) {
                        dateString = `${dateDebut} au ${dateFin}`;
                    }
                    
                    // Calculer la dur√©e
                    let jours = 0;
                    let nuits = 0;
                    if (dateDebutObj && dateFinObj) {
                        const diffTime = Math.abs(dateFinObj.getTime() - dateDebutObj.getTime());
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        nuits = diffDays;
                        jours = diffDays + 1;
                    }
                    
                    // R√©cup√©rer les personnes h√©berg√©es pour cette ligne
                    let personnesLigne = [];
                    const colonnesPersonnes = [colMpihiraLehilahy, colMpitendry, colFeo1, colFeo2];
                    colonnesPersonnes.forEach(colIndex => {
                        if (colIndex !== -1) {
                            const personnes = row[colIndex] || '';
                            if (personnes.trim()) {
                                personnes.split(',').forEach(p => {
                                    const trimmed = p.trim();
                                    if (trimmed) personnesLigne.push(trimmed);
                                });
                            }
                        }
                    });
                    
                    // G√©rer le cas "Tout le monde"
                    const repartition = colRepartition !== -1 ? row[colRepartition] : '';
                    if (repartition && repartition.toLowerCase().includes('tout le monde')) {
                        personnesLigne = Array.from(allHeberges);
                    }
                    
                    if (!hotesMap.has(key)) {
                        hotesMap.set(key, {
                            nom: nom.trim(),
                            pays: paysValue,
                            lieu: lieuValue,
                            dates: [],
                            jours: 0,
                            nuits: 0,
                            sejours: 0,
                            personnes: new Set()
                        });
                    }
                    
                    const hote = hotesMap.get(key);
                    
                    // Ajouter les dates
                    if (dateString) {
                        hote.dates.push(dateString);
                    }
                    
                    // Ajouter la dur√©e
                    hote.jours += jours;
                    hote.nuits += nuits;
                    hote.sejours++;
                    
                    // Ajouter les personnes h√©berg√©es
                    personnesLigne.forEach(p => hote.personnes.add(p));
                }
            });
            
            // Convertir la Map en tableau et trier par nom d'h√¥te
            tableauData = Array.from(hotesMap.values()).map(hote => ({
                ...hote,
                personnes: Array.from(hote.personnes).sort()
            })).sort((a, b) => a.nom.localeCompare(b.nom));
        }
        
        // Fonction pour exporter le tableau
        function exportTableau(format) {
            if (tableauData.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            
            if (format === 'pdf') {
                exportTableauPDF();
            } else if (format === 'excel') {
                exportTableauExcel();
            }
        }
        
        function exportTableauPDF() {
            const printWindow = window.open('', '_blank');
            let pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tableau des h√©bergeurs - Tourn√©e 2026</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #8b0000; text-align: center; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 2px solid #8b0000; }
                        .info { text-align: center; margin-bottom: 30px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background-color: #8b0000; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border: 1px solid #ddd; vertical-align: top; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .personne-tag { background: #ffc107; color: #856404; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin: 1px; display: inline-block; }
                        .duration { font-size: 0.9em; }
                        .jours { background: #ffc107; color: #856404; padding: 2px 6px; border-radius: 5px; }
                        .nuits { background: #17a2b8; color: white; padding: 2px 6px; border-radius: 5px; }
                        .sejours { font-size: 0.8em; color: #666; }
                        @media print {
                            body { margin: 10px; }
                            table { font-size: 11px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üìä Tableau des h√©bergeurs - Tourn√©e 2026</h1>
                    <div class="info">
                        <p>Export g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                        <p>${tableauData.length} h√©bergeur(s) | 
                           ${tableauData.reduce((sum, hote) => sum + hote.sejours, 0)} s√©jour(s) | 
                           ${tableauData.reduce((sum, hote) => sum + hote.jours, 0)} jour(s) | 
                           ${tableauData.reduce((sum, hote) => sum + hote.nuits, 0)} nuit√©e(s)</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>H√¥te</th>
                                <th>Pays</th>
                                <th>Lieu</th>
                                <th>Dates</th>
                                <th>Dur√©e</th>
                                <th>Personnes h√©berg√©es</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            tableauData.forEach(hote => {
                pdfContent += `
                    <tr>
                        <td><strong>${hote.nom}</strong></td>
                        <td>${hote.pays}</td>
                        <td>${hote.lieu}</td>
                        <td>
                            ${hote.dates.map(date => `<div>${date}</div>`).join('')}
                        </td>
                        <td class="duration">
                            <div><span class="jours">${hote.jours} jour${hote.jours > 1 ? 's' : ''}</span></div>
                            <div style="margin-top: 3px;"><span class="nuits">${hote.nuits} nuit√©e${hote.nuits > 1 ? 's' : ''}</span></div>
                            <div class="sejours">(${hote.sejours} s√©jour${hote.sejours > 1 ? 's' : ''})</div>
                        </td>
                        <td>
                            <div style="display: flex; flex-wrap: wrap; gap: 2px;">
                                ${hote.personnes.map(p => `<span class="personne-tag">${p}</span>`).join('')}
                            </div>
                            <div style="margin-top: 5px; font-size: 0.8em; color: #666;">
                                Total: ${hote.personnes.length} personne${hote.personnes.length > 1 ? 's' : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            pdfContent += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        function exportTableauExcel() {
            // Cr√©er le CSV
            let csvContent = 'H√¥te,Pays,Lieu,Dates,Jours,Nuit√©es,S√©jours,Personnes h√©berg√©es\n';
            
            tableauData.forEach(hote => {
                const personnesStr = hote.personnes.map(p => p.replace(/,/g, ';')).join(', ');
                const datesStr = hote.dates.join(' | ');
                
                const row = [
                    `"${hote.nom}"`,
                    `"${hote.pays}"`,
                    `"${hote.lieu}"`,
                    `"${datesStr}"`,
                    hote.jours,
                    hote.nuits,
                    hote.sejours,
                    `"${personnesStr}"`
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // T√©l√©charger le fichier
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `tableau_hebergeurs_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Tableau export√© avec succ√®s! ${tableauData.length} h√©bergeur(s)`);
        }

        // Fonctions pour g√©rer la bulle d'options des personnes h√©berg√©es
        function showPersonOptionsBubble(personElement, personName) {
            currentSelectedPerson = personName;
            currentClickedPersonElement = personElement;
            
            const bubble = document.getElementById('personOptionsBubble');
            const rect = personElement.getBoundingClientRect();
            
            // Positionner la bulle
            if (personElement.classList.contains('tag') || personElement.classList.contains('mobile-tag')) {
                // Si c'est un tag dans la sidebar ou mobile, positionner diff√©remment
                bubble.style.top = (rect.top + window.scrollY) + 'px';
                bubble.style.left = (rect.right + window.scrollX + 5) + 'px';
                bubble.style.transform = 'none';
            } else {
                // Si c'est un tag dans une fiche
                bubble.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                bubble.style.left = (rect.left + window.scrollX + rect.width / 2) + 'px';
                bubble.style.transform = 'translateX(-50%)';
            }
            
            bubble.style.display = 'flex';
            
            // Ajuster la position si la bulle d√©passe de l'√©cran
            setTimeout(() => {
                const bubbleRect = bubble.getBoundingClientRect();
                
                // Si la bulle d√©passe √† droite
                if (bubbleRect.right > window.innerWidth) {
                    if (personElement.classList.contains('tag') || personElement.classList.contains('mobile-tag')) {
                        // Pour les tags sidebar/mobile, mettre √† gauche
                        bubble.style.left = (rect.left + window.scrollX - bubbleRect.width - 5) + 'px';
                    } else {
                        bubble.style.left = (window.innerWidth - bubbleRect.width - 10) + 'px';
                        bubble.style.transform = 'none';
                    }
                }
                
                // Si la bulle d√©passe √† gauche
                if (bubbleRect.left < 0) {
                    bubble.style.left = '10px';
                    bubble.style.transform = 'none';
                }
                
                // Si la bulle d√©passe en bas
                if (bubbleRect.bottom > window.innerHeight) {
                    bubble.style.top = (rect.top + window.scrollY - bubbleRect.height - 5) + 'px';
                }
            }, 10);
        }
        
        function hidePersonBubble() {
            document.getElementById('personOptionsBubble').style.display = 'none';
            currentSelectedPerson = null;
            currentClickedPersonElement = null;
        }
        
        function showHotesForPerson(personName) {
            const results = filterByHeberge(personName);
            const uniqueHotes = new Map();
            
            results.forEach(row => {
                const nom = colNom !== -1 ? row[colNom] : '';
                const pays = colPays !== -1 ? row[colPays] : '';
                const lieu = colLieu !== -1 ? row[colLieu] : '';
                const dateDebut = colDateDebut !== -1 ? row[colDateDebut] : '';
                const dateFin = colDateFin !== -1 ? row[colDateFin] : '';
                
                if (nom && nom.trim()) {
                    const key = nom.trim().toLowerCase();
                    if (!uniqueHotes.has(key)) {
                        uniqueHotes.set(key, {
                            nom: nom.trim(),
                            pays: pays ? pays.trim() : 'Non sp√©cifi√©',
                            lieu: lieu ? lieu.trim() : 'Non sp√©cifi√©',
                            dates: dateDebut && dateFin ? `${dateDebut} au ${dateFin}` : '',
                            jours: 0,
                            nuits: 0,
                            s√©jours: 0
                        });
                    }
                    const hote = uniqueHotes.get(key);
                    hote.s√©jours++;
                    
                    // Calculer le nombre de jours et nuits pour ce s√©jour
                    const dateDebutObj = parseDate(dateDebut);
                    const dateFinObj = parseDate(dateFin);
                    
                    if (dateDebutObj && dateFinObj) {
                        // Calculer la diff√©rence en jours (nombre de nuits)
                        const diffTime = Math.abs(dateFinObj.getTime() - dateDebutObj.getTime());
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        hote.nuits += diffDays;
                        hote.jours += diffDays + 1; // +1 car le jour d'arriv√©e compte
                    }
                }
            });
            
            const hotesList = Array.from(uniqueHotes.values());
            
            // Calculer les totaux
            const totalJours = hotesList.reduce((sum, hote) => sum + hote.jours, 0);
            const totalNuits = hotesList.reduce((sum, hote) => sum + hote.nuits, 0);
            const totalS√©jours = hotesList.reduce((sum, hote) => sum + hote.s√©jours, 0);
            
            let html = `
                <div class="fiche-item">
                    <div class="fiche-header">
                        <h2>üë§ H√¥tes pour: ${personName}</h2>
                        <h3 class="fiche-title">${hotesList.length} h√¥te(s) trouv√©(s) - ${totalS√©jours} s√©jour(s)</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px; background: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                            <strong>üìä R√©capitulatif:</strong> ${personName} a √©t√© h√©berg√©(e) chez ${hotesList.length} h√¥te(s) diff√©rent(s) pour un total de ${totalS√©jours} s√©jour(s), soit ${totalNuits} nuit√©e(s) et ${totalJours} jour(s).
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">H√¥te</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Pays</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Lieu</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Dates</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Dur√©e</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${hotesList.map(hote => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 10px;">
                                            <div style="font-weight: bold; color: #27ae60; cursor: pointer; text-decoration: underline;" class="hote-link" data-hote="${hote.nom}">${hote.nom}</div>
                                        </td>
                                        <td style="padding: 10px;">
                                            <span style="display: inline-block; padding: 4px 8px; background: #27ae60; color: white; border-radius: 12px; font-size: 0.9em;">
                                                ${hote.pays}
                                            </span>
                                        </td>
                                        <td style="padding: 10px;">${hote.lieu}</td>
                                        <td style="padding: 10px; font-size: 0.9em; color: #666;">${hote.dates}</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <div style="display: flex; flex-direction: column; align-items: center;">
                                                    <span style="display: inline-block; padding: 3px 8px; background: #ffc107; color: #856404; border-radius: 8px; font-weight: bold; font-size: 0.9em;">
                                                        ${hote.jours} jour${hote.jours > 1 ? 's' : ''}
                                                    </span>
                                                    <span style="display: inline-block; padding: 3px 8px; background: #17a2b8; color: white; border-radius: 8px; font-weight: bold; font-size: 0.9em; margin-top: 3px;">
                                                        ${hote.nuits} nuit√©e${hote.nuits > 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                <div style="font-size: 0.8em; color: #6c757d; margin-top: 3px;">
                                                    (${hote.s√©jours} s√©jour${hote.s√©jours > 1 ? 's' : ''})
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <strong>üí° Note:</strong> Cliquez sur le nom d'un h√¥te pour voir ses fiches d√©taill√©es.
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('resultContent').innerHTML = html;
            document.getElementById('resultTitle').textContent = `H√¥tes pour: ${personName}`;
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('tableauSection').style.display = 'none';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            // Ajouter des √©v√©nements de clic sur les noms d'h√¥tes
            setTimeout(() => {
                document.querySelectorAll('.hote-link').forEach((link) => {
                    link.addEventListener('click', function() {
                        const hoteName = this.getAttribute('data-hote');
                        showFichesForHote(hoteName);
                    });
                });
            }, 100);
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('adminPassword').focus();
        }

        function showExportModal() {
            if (sheetData.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            
            resetExportModal();
            document.getElementById('exportModal').style.display = 'flex';
        }

        function resetExportModal() {
            selectedExportType = null;
            selectedExportFormat = null;
            document.getElementById('exportType1').classList.remove('selected');
            document.getElementById('exportType2').classList.remove('selected');
            document.getElementById('exportType3').classList.remove('selected');
            document.getElementById('exportType4').classList.remove('selected');
            document.querySelectorAll('.format-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('formatOptions').style.display = 'none';
            document.getElementById('confirmExport').style.display = 'none';
        }

        function selectExportType(type) {
            selectedExportType = type;
            document.getElementById('exportType1').classList.remove('selected');
            document.getElementById('exportType2').classList.remove('selected');
            document.getElementById('exportType3').classList.remove('selected');
            document.getElementById('exportType4').classList.add('selected');
            
            // Pour le type 3 (fiches) et 4 (tableau), on n'affiche pas les options de format, c'est toujours PDF
            if (type === 3 || type === 4) {
                document.getElementById('formatOptions').style.display = 'none';
                document.getElementById('confirmExport').style.display = 'block';
                selectedExportFormat = 'pdf';
            } else {
                document.getElementById('formatOptions').style.display = 'flex';
                document.getElementById('confirmExport').style.display = 'none';
            }
        }

        function exportData() {
            if (!selectedExportType || (selectedExportType !== 3 && selectedExportType !== 4 && !selectedExportFormat)) {
                alert('Veuillez s√©lectionner un type et un format d\'exportation');
                return;
            }
            
            document.getElementById('exportModal').style.display = 'none';
            
            if (selectedExportType === 3) {
                // Export des fiches d√©taill√©es
                exportFiches(sheetData, 'fiches_hebergements_completes');
            } else if (selectedExportType === 4) {
                // Export du tableau des h√©bergeurs
                generateTableauData();
                exportTableauPDF();
            } else {
                let exportData = [];
                let filename = '';
                let mimeType = '';
                let content = '';
                
                if (selectedExportType === 1) {
                    // Export de tous les h√©bergeurs avec leurs informations
                    filename = 'liste_tous_hebergeurs';
                    
                    // Cr√©er les en-t√™tes pour l'export
                    const exportHeaders = ['Nom', 'Email', 'T√©l√©phone', 'Facebook', 'Adresse', 'Lieu', 'Pays', 'Type', 'Date D√©but', 'Date Fin'];
                    
                    // R√©cup√©rer tous les h√©bergeurs uniques
                    const uniqueHebergeurs = new Map();
                    
                    sheetData.forEach((row, index) => {
                        const nom = colNom !== -1 ? row[colNom] : '';
                        const email = colEmail !== -1 ? row[colEmail] : '';
                        const telephone = colTelephone !== -1 ? row[colTelephone] : '';
                        const facebook = colFacebook !== -1 ? row[colFacebook] : '';
                        const adresse = colAdresse !== -1 ? row[colAdresse] : '';
                        const lieu = colLieu !== -1 ? row[colLieu] : '';
                        const pays = colPays !== -1 ? row[colPays] : '';
                        const type = colHebergeEn !== -1 ? row[colHebergeEn] : '';
                        const dateDebut = colDateDebut !== -1 ? row[colDateDebut] : '';
                        const dateFin = colDateFin !== -1 ? row[colDateFin] : '';
                        
                        if (nom && nom.trim()) {
                            const key = nom.trim().toLowerCase();
                            if (!uniqueHebergeurs.has(key)) {
                                uniqueHebergeurs.set(key, {
                                    nom: nom.trim(),
                                    email: email ? email.trim() : '',
                                    telephone: telephone ? telephone.trim() : '',
                                    facebook: facebook ? facebook.trim() : '',
                                    adresse: adresse ? adresse.trim() : '',
                                    lieu: lieu ? lieu.trim() : '',
                                    pays: pays ? pays.trim() : '',
                                    type: type ? type.trim() : '',
                                    dates: dateDebut && dateFin ? `${dateDebut} au ${dateFin}` : ''
                                });
                            }
                        }
                    });
                    
                    // Convertir en tableau pour l'export
                    exportData = Array.from(uniqueHebergeurs.values());
                    
                    if (selectedExportFormat === 'csv' || selectedExportFormat === 'excel') {
                        // Cr√©er le CSV
                        let csvContent = exportHeaders.join(',') + '\n';
                        
                        exportData.forEach(item => {
                            const row = [
                                `"${item.nom}"`,
                                `"${item.email}"`,
                                `"${item.telephone}"`,
                                `"${item.facebook}"`,
                                `"${item.adresse}"`,
                                `"${item.lieu}"`,
                                `"${item.pays}"`,
                                `"${item.type}"`,
                                `"${item.dates}"`
                            ];
                            csvContent += row.join(',') + '\n';
                        });
                        
                        content = csvContent;
                        filename += '.csv';
                        mimeType = 'text/csv;charset=utf-8;';
                        
                    } else if (selectedExportFormat === 'pdf') {
                        // Cr√©er le PDF (version simplifi√©e - ouvre une nouvelle fen√™tre)
                        createPDFExport(exportData, 'Liste de tous les h√©bergeurs', exportHeaders, filename);
                        return;
                    }
                    
                } else if (selectedExportType === 2) {
                    // Export par pays
                    filename = 'liste_hebergeurs_par_pays';
                    
                    // Organiser par pays
                    const hebergeursParPays = {};
                    
                    sheetData.forEach((row, index) => {
                        const nom = colNom !== -1 ? row[colNom] : '';
                        const pays = colPays !== -1 ? row[colPays] : '';
                        const email = colEmail !== -1 ? row[colEmail] : '';
                        const telephone = colTelephone !== -1 ? row[colTelephone] : '';
                        const adresse = colAdresse !== -1 ? row[colAdresse] : '';
                        const lieu = colLieu !== -1 ? row[colLieu] : '';
                        const type = colHebergeEn !== -1 ? row[colHebergeEn] : '';
                        const dateDebut = colDateDebut !== -1 ? row[colDateDebut] : '';
                        const dateFin = colDateFin !== -1 ? row[colDateFin] : '';
                        
                        if (pays && pays.trim() && nom && nom.trim()) {
                            const paysKey = pays.trim();
                            
                            if (!hebergeursParPays[paysKey]) {
                                hebergeursParPays[paysKey] = [];
                            }
                            
                            const hebergeurKey = nom.trim().toLowerCase();
                            const existeDeja = hebergeursParPays[paysKey].some(h => 
                                h.nom.toLowerCase() === hebergeurKey
                            );
                            
                            if (!existeDeja) {
                                hebergeursParPays[paysKey].push({
                                    nom: nom.trim(),
                                    email: email ? email.trim() : '',
                                    telephone: telephone ? telephone.trim() : '',
                                    adresse: adresse ? adresse.trim() : '',
                                    lieu: lieu ? lieu.trim() : '',
                                    type: type ? type.trim() : '',
                                    dates: dateDebut && dateFin ? `${dateDebut} au ${dateFin}` : ''
                                });
                            }
                        }
                    });
                    
                    if (selectedExportFormat === 'csv' || selectedExportFormat === 'excel') {
                        // Cr√©er le CSV
                        let csvContent = 'Pays,Nom,Email,T√©l√©phone,Adresse,Lieu,Type,Dates\n';
                        
                        Object.keys(hebergeursParPays).sort().forEach(pays => {
                            hebergeursParPays[pays].forEach(hebergeur => {
                                const row = [
                                    `"${pays}"`,
                                    `"${hebergeur.nom}"`,
                                    `"${hebergeur.email}"`,
                                    `"${hebergeur.telephone}"`,
                                    `"${hebergeur.adresse}"`,
                                    `"${hebergeur.lieu}"`,
                                    `"${hebergeur.type}"`,
                                    `"${hebergeur.dates}"`
                                ];
                                csvContent += row.join(',') + '\n';
                            });
                        });
                        
                        content = csvContent;
                        filename += '.csv';
                        mimeType = 'text/csv;charset=utf-8;';
                        
                    } else if (selectedExportFormat === 'pdf') {
                        // Cr√©er le PDF par pays
                        createPDFByCountryExport(hebergeursParPays, filename);
                        return;
                    }
                }
                
                // T√©l√©charger le fichier pour CSV/Excel
                downloadFile(content, filename, mimeType);
            }
            
            resetExportModal();
        }
        
        function exportFiches(rows, baseFilename) {
            if (rows.length === 0) {
                alert('Aucune fiche √† exporter');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            let pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Fiches d'h√©bergement - Tourn√©e 2026</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #8b0000; text-align: center; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 2px solid #8b0000; }
                        .fiche-container { margin-bottom: 40px; page-break-inside: avoid; border: 1px solid #ddd; padding: 20px; border-radius: 10px; }
                        .fiche-header { background: #6c757d; color: white; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
                        .fiche-title { color: white; font-size: 1.2em; margin: 0; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
                        .info-item { padding: 10px; background: #f8f9fa; border-radius: 5px; }
                        .info-label { font-weight: bold; color: #8b0000; font-size: 0.9em; margin-bottom: 5px; }
                        .info-value { color: #2c3e50; }
                        .hote-section { background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
                        .hote-name { font-size: 1.5em; color: #27ae60; font-weight: bold; margin-top: 5px; }
                        .section { margin-bottom: 15px; padding: 15px; border-left: 4px solid #3498db; background: #f8f9fa; border-radius: 5px; }
                        .section-title { font-weight: bold; color: #2c3e50; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
                        .type-section { border-left-color: #2196F3; background: #e3f2fd; }
                        .type-title { color: #0d47a1; }
                        @media print {
                            .fiche-container { page-break-inside: avoid; }
                            body { margin: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üìÑ Fiches d'h√©bergement - Tourn√©e 2026</h1>
                    <p style="text-align: center; margin-bottom: 30px; color: #666;">
                        Export g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} - ${rows.length} fiche(s)
                    </p>
            `;
            
            rows.forEach((row, index) => {
                const dateDebut = colDateDebut !== -1 ? row[colDateDebut] : '';
                const dateFin = colDateFin !== -1 ? row[colDateFin] : '';
                const nom = colNom !== -1 ? row[colNom] : '';
                const pays = colPays !== -1 ? row[colPays] : '';
                const lieu = colLieu !== -1 ? row[colLieu] : '';
                const adresse = colAdresse !== -1 ? row[colAdresse] : '';
                const email = colEmail !== -1 ? row[colEmail] : '';
                const facebook = colFacebook !== -1 ? row[colFacebook] : '';
                const telephone = colTelephone !== -1 ? row[colTelephone] : '';
                const mpihiraLehilahy = colMpihiraLehilahy !== -1 ? row[colMpihiraLehilahy] : '';
                const mpitendry = colMpitendry !== -1 ? row[colMpitendry] : '';
                const feo1 = colFeo1 !== -1 ? row[colFeo1] : '';
                const feo2 = colFeo2 !== -1 ? row[colFeo2] : '';
                const priere = colPriere !== -1 ? row[colPriere] : '';
                const marquants = colMarquants !== -1 ? row[colMarquants] : '';
                const photosHotes = colPhotosHotes !== -1 ? row[colPhotosHotes] : '';
                const photosLieux = colPhotosLieux !== -1 ? row[colPhotosLieux] : '';
                const formulaire = colFormulaire !== -1 ? row[colFormulaire] : '';
                const repartition = colRepartition !== -1 ? row[colRepartition] : '';
                const type = colHebergeEn !== -1 ? row[colHebergeEn] : '';
                
                const adresseHebergeur = colAdresseHebergeur !== -1 ? row[colAdresseHebergeur] : '';
                const lieuHebergeur = colLieuHebergeur !== -1 ? row[colLieuHebergeur] : '';
                const paysHebergeur = colPaysHebergeur !== -1 ? row[colPaysHebergeur] : '';
                const numeroHebergeur = colNumeroHebergeur !== -1 ? row[colNumeroHebergeur] : '';
                
                const aSavoirHote = colASavoirHote !== -1 ? row[colASavoirHote] : '';
                
                let toutesPersonnes = [];
                const colonnesPersonnes = [
                    {data: mpihiraLehilahy, type: 'Mpihira Lehilahy'},
                    {data: mpitendry, type: 'Mpitendry'},
                    {data: feo1, type: 'Feo 1'},
                    {data: feo2, type: 'Feo 2'}
                ];
                
                colonnesPersonnes.forEach(col => {
                    if (col.data && col.data.trim()) {
                        col.data.split(',').forEach(p => {
                            const trimmed = p.trim();
                            if (trimmed) toutesPersonnes.push(trimmed);
                        });
                    }
                });
                
                let personnesAffichees = '';
                let personnesPourTags = [];
                
                if (repartition && repartition.trim()) {
                    if (repartition.toLowerCase().includes('tout le monde')) {
                        personnesPourTags = Array.from(allHeberges);
                        personnesAffichees = `Tout le monde / ${personnesPourTags.join(', ')}`;
                    } else {
                        personnesPourTags = toutesPersonnes;
                        personnesAffichees = `${repartition} / ${toutesPersonnes.join(', ')}`;
                    }
                } else {
                    personnesPourTags = toutesPersonnes;
                    personnesAffichees = toutesPersonnes.join(', ');
                }
                
                const titreFiche = `${dateDebut || '?'} - ${dateFin || '?'} / ${personnesPourTags.length > 0 ? personnesPourTags.join(', ') : 'Aucun h√©berg√©'}`;
                
                pdfContent += `
                    <div class="fiche-container">
                        <div class="fiche-header">
                            <h2 class="fiche-title">üè® H√©bergement Tourn√©e 2026 - Fiche ${index + 1}</h2>
                            <div style="color: #e0e0e0; margin-top: 5px;">${titreFiche}</div>
                        </div>
                        
                        <div class="hote-section">
                            <div style="font-weight: bold; color: #27ae60;">üë§ H√©berg√© chez :</div>
                            <div class="hote-name">${nom || 'H√¥te non sp√©cifi√©'}</div>
                        </div>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">üìÖ Date d√©but:</div>
                                <div class="info-value">${dateDebut || 'Non sp√©cifi√©e'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">üìÖ Date fin:</div>
                                <div class="info-value">${dateFin || 'Non sp√©cifi√©e'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">üìç Lieu:</div>
                                <div class="info-value">${lieu || 'Non sp√©cifi√©'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">üåç Pays:</div>
                                <div class="info-value">${pays || 'Non sp√©cifi√©'}</div>
                            </div>
                        </div>
                        
                        ${type ? `
                        <div class="section type-section">
                            <div class="section-title type-title">üè† H√©berg√© en:</div>
                            <div>${type}</div>
                        </div>
                        ` : ''}
                        
                        ${personnesPourTags.length > 0 ? `
                        <div class="section" style="border-left-color: #ffc107;">
                            <div class="section-title">üë• Les h√©berg√©s:</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">
                                ${personnesPourTags.map(p => `<span style="background: #ffc107; color: #856404; padding: 4px 8px; border-radius: 12px; font-size: 0.9em;">${p}</span>`).join('')}
                            </div>
                            <div style="margin-top: 10px; font-style: italic; color: #666;">
                                ${personnesAffichees}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${(adresseHebergeur || email || facebook || telephone || numeroHebergeur) ? `
                        <div class="section" style="border-left-color: #3498db;">
                            <div class="section-title">üìû Information de contact:</div>
                            ${adresseHebergeur ? `<div style="margin-bottom: 8px;"><strong>üìç Adresse:</strong> ${adresseHebergeur}</div>` : ''}
                            ${numeroHebergeur ? `<div style="margin-bottom: 8px;"><strong>üî¢ Num√©ro:</strong> ${numeroHebergeur}</div>` : ''}
                            ${email ? `<div style="margin-bottom: 8px;"><strong>üìß Email:</strong> ${email}</div>` : ''}
                            ${facebook ? `<div style="margin-bottom: 8px;"><strong>üë• R√©seaux sociaux:</strong> ${facebook}</div>` : ''}
                            ${telephone ? `<div style="margin-bottom: 8px;"><strong>üì± T√©l√©phone:</strong> <a href="tel:${telephone}">${telephone}</a></div>` : ''}
                        </div>
                        ` : ''}
                        
                        ${aSavoirHote ? `
                        <div class="section" style="border-left-color: #e65100;">
                            <div class="section-title">‚ÑπÔ∏è √Ä savoir sur le h√¥te:</div>
                            <div>${aSavoirHote}</div>
                        </div>
                        ` : ''}
                        
                        ${marquants ? `
                        <div class="section" style="border-left-color: #9b59b6;">
                            <div class="section-title">‚≠ê Marquants:</div>
                            <div>${marquants}</div>
                        </div>
                        ` : ''}
                        
                        ${priere ? `
                        <div class="section" style="border-left-color: #e74c3c;">
                            <div class="section-title">üôè Sujet de pri√®re:</div>
                            <div>${priere}</div>
                        </div>
                        ` : ''}
                        
                        ${(photosHotes || photosLieux || formulaire) ? `
                        <div class="section" style="border-left-color: #27ae60;">
                            <div class="section-title">üîó Liens et photos:</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                ${photosHotes ? `<span style="background: #9b59b6; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">üì∏ Photos avec h√¥tes</span>` : ''}
                                ${photosLieux ? `<span style="background: #e74c3c; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">üèûÔ∏è Photos des lieux</span>` : ''}
                                ${formulaire ? `<span style="background: #27ae60; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">üîó Formulaire</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            pdfContent += `</body></html>`;
            
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        function createPDFExport(data, title, headers, filename) {
            const printWindow = window.open('', '_blank');
            let pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title} - Tourn√©e 2026</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #8b0000; text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background-color: #8b0000; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h1>${title} - Tourn√©e 2026</h1>
                    <p>Export g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                    <table>
                        <thead>
                            <tr>
                                ${headers.map(header => `<th>${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td>${item.nom}</td>
                                    <td>${item.email}</td>
                                    <td>${item.telephone}</td>
                                    <td>${item.facebook}</td>
                                    <td>${item.adresse}</td>
                                    <td>${item.lieu}</td>
                                    <td>${item.pays}</td>
                                    <td>${item.type}</td>
                                    <td>${item.dates}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        function createPDFByCountryExport(hebergeursParPays, filename) {
            const printWindow = window.open('', '_blank');
            let pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Liste des h√©bergeurs par pays - Tourn√©e 2026</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #8b0000; text-align: center; margin-bottom: 30px; }
                        h2 { color: #2c3e50; margin-top: 30px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th { background-color: #27ae60; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .country-section { margin-bottom: 40px; }
                        .type { background: #2196F3; color: white; padding: 2px 6px; border-radius: 5px; font-size: 0.9em; }
                    </style>
                </head>
                <body>
                    <h1>üåç Liste des h√©bergeurs par pays - Tourn√©e 2026</h1>
                    <p>Export g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}</p>
            `;
            
            Object.keys(hebergeursParPays).sort().forEach(pays => {
                pdfContent += `
                    <div class="country-section">
                        <h2>${pays}</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>T√©l√©phone</th>
                                    <th>Adresse</th>
                                    <th>Lieu</th>
                                    <th>Type</th>
                                    <th>Dates</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${hebergeursParPays[pays].map(hebergeur => `
                                    <tr>
                                        <td>${hebergeur.nom}</td>
                                        <td>${hebergeur.email}</td>
                                        <td>${hebergeur.telephone}</td>
                                        <td>${hebergeur.adresse}</td>
                                        <td>${hebergeur.lieu}</td>
                                        <td><span class="type">${hebergeur.type}</span></td>
                                        <td>${hebergeur.dates}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            pdfContent += `</body></html>`;
            
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Fonction pour t√©l√©charger un fichier
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Fichier ${filename} t√©l√©charg√© avec succ√®s!`);
        }

        function handlePhotoUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert(`La photo "${file.name}" est trop volumineuse. Maximum 5MB.`);
                    continue;
                }
                
                if (!file.type.startsWith('image/')) {
                    alert(`Le fichier "${file.name}" n'est pas une image valide.`);
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const photoData = {
                        name: file.name,
                        size: formatFileSize(file.size),
                        data: e.target.result,
                        type: file.type
                    };
                    
                    uploadedPhotos.push(photoData);
                    renderPhotoPreview();
                };
                
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }

        function renderPhotoPreview() {
            const previewContainer = document.getElementById('photosPreview');
            previewContainer.innerHTML = '';
            
            if (uploadedPhotos.length === 0) {
                previewContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Aucune photo s√©lectionn√©e</div>';
                return;
            }
            
            uploadedPhotos.forEach((photo, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-preview';
                photoElement.innerHTML = `
                    <img src="${photo.data}" alt="${photo.name}">
                    <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                    <div class="photo-info">${photo.name}<br>${photo.size}</div>
                `;
                previewContainer.appendChild(photoElement);
            });
        }

        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            renderPhotoPreview();
        }

        function clearUploadedPhotos() {
            uploadedPhotos = [];
            renderPhotoPreview();
            document.getElementById('photoUpload').value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showEmailModal() {
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            const modal = document.getElementById('emailModal');
            const recipientsContainer = document.getElementById('emailRecipients');
            const recipientCount = document.getElementById('recipientCount');
            
            const hotesAvecEmail = sheetData.filter(row => {
                const email = colEmail !== -1 ? row[colEmail] : '';
                const nom = colNom !== -1 ? row[colNom] : '';
                return email && email.trim() && nom && nom.trim();
            });
            
            const uniqueHotes = [];
            const emailsDejaVus = new Set();
            
            hotesAvecEmail.forEach(hote => {
                const email = hote[colEmail].trim().toLowerCase();
                if (!emailsDejaVus.has(email)) {
                    emailsDejaVus.add(email);
                    uniqueHotes.push(hote);
                }
            });
            
            recipientsContainer.innerHTML = '';
            uniqueHotes.forEach((hote, index) => {
                const recipientDiv = document.createElement('div');
                recipientDiv.className = 'recipient-item';
                recipientDiv.innerHTML = `
                    <input type="checkbox" class="recipient-checkbox" data-index="${index}" checked style="margin-right: 10px;">
                    <div>
                        <strong>${hote[colNom]}</strong><br>
                        <small style="color: #666;">${hote[colEmail]}</small>
                    </div>
                `;
                recipientsContainer.appendChild(recipientDiv);
            });
            
            recipientCount.textContent = uniqueHotes.length;
            modal.style.display = 'flex';
        }

        function sendEmails() {
            const checkboxes = document.querySelectorAll('.recipient-checkbox:checked');
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            if (checkboxes.length === 0) {
                alert('Veuillez s√©lectionner au moins un destinataire');
                return;
            }
            
            // R√©cup√©rer les emails s√©lectionn√©s
            const emails = [];
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.getAttribute('data-index'));
                const hote = sheetData.filter(row => {
                    const email = colEmail !== -1 ? row[colEmail] : '';
                    const nom = colNom !== -1 ? row[colNom] : '';
                    return email && email.trim() && nom && nom.trim();
                })[index];
                
                if (hote) {
                    emails.push({
                        nom: hote[colNom],
                        email: hote[colEmail]
                    });
                }
            });
            
            // Pr√©parer le corps de l'email avec les photos
            let emailBody = message;
            
            if (uploadedPhotos.length > 0) {
                emailBody += '\n\n---\nüì∏ Photos jointes √† cet email :\n';
                uploadedPhotos.forEach(photo => {
                    emailBody += `‚Ä¢ ${photo.name} (${photo.size})\n`;
                });
                emailBody += '\nLes photos sont jointes √† cet email.';
            }
            
            const encodedBody = encodeURIComponent(emailBody);
            const encodedSubject = encodeURIComponent(subject);
            
            const emailRecipients = emails.map(e => e.email).join(',');
            
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${emailRecipients}&su=${encodedSubject}&body=${encodedBody}`;
            
            window.open(gmailUrl, '_blank');
            
            if (uploadedPhotos.length > 0) {
                setTimeout(() => {
                    alert(`${emails.length} email(s) pr√©par√©(s) pour envoi.\n\nüì∏ IMPORTANT: Les photos doivent √™tre ajout√©es manuellement en pi√®ces jointes dans votre client email.\n\nPhotos √† attacher:\n${uploadedPhotos.map(p => `‚Ä¢ ${p.name}`).join('\n')}`);
                }, 1000);
            } else {
                alert(`${emails.length} email(s) pr√©par√©(s) pour envoi. V√©rifiez les destinataires avant d'envoyer.`);
            }
            
            document.getElementById('emailModal').style.display = 'none';
            clearUploadedPhotos();
        }

        function copyEmailAddresses() {
            const checkboxes = document.querySelectorAll('.recipient-checkbox:checked');
            const emails = [];
            
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.getAttribute('data-index'));
                const hote = sheetData.filter(row => {
                    const email = colEmail !== -1 ? row[colEmail] : '';
                    const nom = colNom !== -1 ? row[colNom] : '';
                    return email && email.trim() && nom && nom.trim();
                })[index];
                
                if (hote) {
                    emails.push(hote[colEmail]);
                }
            });
            
            if (emails.length === 0) {
                alert('Aucun email √† copier');
                return;
            }
            
            const emailString = emails.join('; ');
            navigator.clipboard.writeText(emailString).then(() => {
                alert(`${emails.length} adresse(s) email copi√©e(s) dans le presse-papier`);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
                const textArea = document.createElement('textarea');
                textArea.value = emailString;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`${emails.length} adresse(s) email copi√©e(s) dans le presse-papier`);
            });
        }
        
        async function loadDataFromGoogleSheets() {
            console.log('üîç D√©but du chargement des donn√©es...');
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                console.log('üîÑ Essai 1: Acc√®s direct...');
                let response = await fetch(GOOGLE_SHEETS_URL);
                
                if (response.ok) {
                    const csvText = await response.text();
                    console.log('‚úÖ Succ√®s avec acc√®s direct');
                    processCSVData(csvText);
                    return;
                }
                throw new Error(`Direct failed: ${response.status}`);
                
            } catch (error1) {
                console.log('‚ùå √âchec acc√®s direct:', error1.message);
                
                try {
                    console.log('üîÑ Essai 2: AllOrigins...');
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    let response = await fetch(proxyUrl + encodeURIComponent(GOOGLE_SHEETS_URL));
                    
                    if (response.ok) {
                        const csvText = await response.text();
                        console.log('‚úÖ Succ√®s avec AllOrigins');
                        processCSVData(csvText);
                        return;
                    }
                    throw new Error(`AllOrigins failed: ${response.status}`);
                    
                } catch (error2) {
                    console.log('‚ùå √âchec AllOrigins:', error2.message);
                    showError('Impossible de charger les donn√©es. V√©rifiez votre connexion internet.');
                }
            }
        }

        function parseCSVWithNewlines(csvText) {
            console.log('üîÑ Parsing CSV avec gestion des retours √† la ligne...');
            
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false;
            let quoteChar = '"';
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === quoteChar) {
                    if (inQuotes && nextChar === quoteChar) {
                        currentField += quoteChar;
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentLine.push(currentField);
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentLine.push(currentField);
                    lines.push(currentLine);
                    currentLine = [];
                    currentField = '';
                } else if (char === '\r') {
                    if (nextChar === '\n' && !inQuotes) {
                        currentLine.push(currentField);
                        lines.push(currentLine);
                        currentLine = [];
                        currentField = '';
                        i++;
                    }
                } else {
                    currentField += char;
                }
            }
            
            if (currentField !== '' || currentLine.length > 0) {
                currentLine.push(currentField);
                lines.push(currentLine);
            }
            
            console.log(`‚úÖ Parsing termin√©: ${lines.length} lignes d√©tect√©es`);
            return lines;
        }
        
        function processCSVData(csvText) {
            try {
                console.log('üìÑ Traitement des donn√©es CSV...');
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Le fichier CSV est vide');
                }
                
                const lines = parseCSVWithNewlines(csvText);
                
                if (!lines || lines.length === 0) {
                    throw new Error('Aucune donn√©e pars√©e');
                }
                
                headers = lines[0] || [];
                console.log('üè∑Ô∏è En-t√™tes d√©tect√©s:', headers);
                
                detectColumns();
                
                sheetData = lines.slice(1).filter(row => 
                    row && row.some(cell => cell && cell.trim() !== '')
                );
                
                console.log('üìà Donn√©es extraites:', sheetData.length, 'h√©bergements');
                
                if (sheetData.length === 0) {
                    throw new Error('Aucun h√©bergement avec des donn√©es trouv√©');
                }
                
                normalizeData();
                extractAllData();
                updateStats();
                renderFilterTags();
                renderMobileFilterTags();
                renderCalendar();
                showDataInfo();
                
            } catch (error) {
                console.error('‚ùå Erreur de traitement:', error);
                showError(error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        function detectColumns() {
            headers.forEach((header, index) => {
                const lowerHeader = header.toLowerCase();
                
                if (lowerHeader.includes('date d√©but') || lowerHeader.includes('date debut')) {
                    colDateDebut = index;
                    console.log('üìÖ Colonne Date d√©but d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('date fin')) {
                    colDateFin = index;
                    console.log('üìÖ Colonne Date fin d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('nom') && !lowerHeader.includes('facebook') && !lowerHeader.includes('r√©seau')) {
                    colNom = index;
                    console.log('üë§ Colonne Nom d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('pays')) {
                    colPays = index;
                    console.log('üåç Colonne Pays d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('lieu:')) {
                    colLieu = index;
                    console.log('üìç Colonne Lieu: d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('adresse') && !lowerHeader.includes('e-mail')) {
                    colAdresse = index;
                    console.log('üè† Colonne Adresse d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('e-mail') || lowerHeader.includes('email')) {
                    colEmail = index;
                    console.log('üìß Colonne Email d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('facebook') || lowerHeader.includes('r√©seau')) {
                    colFacebook = index;
                    console.log('üë• Colonne Facebook d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('t√©l√©phone') || lowerHeader.includes('telephone') || lowerHeader.includes('whatsapp')) {
                    colTelephone = index;
                    console.log('üì± Colonne T√©l√©phone d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('mpihira lehilahy')) {
                    colMpihiraLehilahy = index;
                    console.log('üé§ Colonne Mpihira Lehilahy d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('mpitendry')) {
                    colMpitendry = index;
                    console.log('üéπ Colonne Mpitendry d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('feo 1')) {
                    colFeo1 = index;
                    console.log('üéµ Colonne Feo 1 d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('feo 2')) {
                    colFeo2 = index;
                    console.log('üéµ Colonne Feo 2 d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('sujet de pri√®re') || lowerHeader.includes('pri√®re')) {
                    colPriere = index;
                    console.log('üôè Colonne Pri√®re d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('marquant')) {
                    colMarquants = index;
                    console.log('‚≠ê Colonne Marquants d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('photos avec les h√¥tes')) {
                    colPhotosHotes = index;
                    console.log('üì∏ Colonne Photos h√¥tes d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('photos des lieux')) {
                    colPhotosLieux = index;
                    console.log('üèûÔ∏è Colonne Photos lieux d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('lien de ce formulaire')) {
                    colFormulaire = index;
                    console.log('üîó Colonne Formulaire d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('r√©partition')) {
                    colRepartition = index;
                    console.log('üë• Colonne R√©partition d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('heberg√© en') || lowerHeader.includes('h√©berg√© en')) {
                    colHebergeEn = index;
                    console.log('üè† Colonne H√©berg√© en d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('adresse:') && !lowerHeader.includes('e-mail')) {
                    colAdresseHebergeur = index;
                    console.log('üìç Colonne Adresse h√©bergeur d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('lieu:') && lowerHeader !== 'lieu:') {
                    colLieuHebergeur = index;
                    console.log('üèôÔ∏è Colonne Lieu h√©bergeur d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('pays:') && lowerHeader !== 'pays') {
                    colPaysHebergeur = index;
                    console.log('üåç Colonne Pays h√©bergeur d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('num√©ro:') || lowerHeader.includes('numero:')) {
                    colNumeroHebergeur = index;
                    console.log('üî¢ Colonne Num√©ro h√©bergeur d√©tect√©e:', index);
                }
                else if (lowerHeader.includes('savoir sur le h√¥te') || lowerHeader.includes('savoir sur l\'h√©bergeur') || lowerHeader.includes('√† savoir')) {
                    colASavoirHote = index;
                    console.log('‚ÑπÔ∏è Colonne √Ä savoir sur le h√¥te d√©tect√©e:', index);
                }
            });
        }
        
        function normalizeData() {
            let maxColumns = headers.length;
            sheetData.forEach(row => {
                if (row.length > maxColumns) {
                    maxColumns = row.length;
                }
            });
            
            while (headers.length < maxColumns) {
                headers.push(`Colonne ${headers.length + 1}`);
            }
            
            sheetData.forEach(row => {
                while (row.length < maxColumns) {
                    row.push('');
                }
                if (row.length > maxColumns) {
                    row.length = maxColumns;
                }
            });
            
            console.log(`üìê Donn√©es normalis√©es: ${maxColumns} colonnes`);
        }
        
        function extractAllData() {
            allHotes = new Set();
            allPays = new Set();
            allLieux = new Set();
            allHeberges.clear();
            allPrieres = [];
            bookingPeriods = [];
            allTypes.clear();
            
            // R√©initialiser les compteurs de type d'h√©bergement
            typeFamille = 0;
            typeHotel = 0;
            typeCentre = 0;
            typeAutre = 0;
            
            sheetData.forEach((row, index) => {
                if (colNom !== -1) {
                    const nom = row[colNom] || '';
                    if (nom.trim()) allHotes.add(nom.trim());
                }
                
                if (colPays !== -1) {
                    const pays = row[colPays] || '';
                    if (pays.trim()) allPays.add(pays.trim());
                }
                
                if (colLieu !== -1) {
                    const lieu = row[colLieu] || '';
                    if (lieu.trim()) allLieux.add(lieu.trim());
                }
                
                const colonnesPersonnes = [colMpihiraLehilahy, colMpitendry, colFeo1, colFeo2];
                colonnesPersonnes.forEach(colIndex => {
                    if (colIndex !== -1) {
                        const personnes = row[colIndex] || '';
                        if (personnes.trim()) {
                            personnes.split(',').forEach(p => {
                                const trimmed = p.trim();
                                if (trimmed) allHeberges.add(trimmed);
                            });
                        }
                    }
                });
                
                if (colPriere !== -1) {
                    const priere = row[colPriere] || '';
                    if (priere.trim()) {
                        allPrieres.push({
                            hote: row[colNom] || 'Anonyme',
                            priere: priere,
                            rowIndex: index
                        });
                    }
                }
                
                // D√©tecter et compter les types d'h√©bergement
                if (colHebergeEn !== -1) {
                    const typeValue = (row[colHebergeEn] || '').trim();
                    if (typeValue) {
                        allTypes.add(typeValue);
                        
                        const typeLower = typeValue.toLowerCase();
                        if (typeLower.includes('famille')) {
                            typeFamille++;
                        } else if (typeLower.includes('hotel') || typeLower.includes('h√¥tel')) {
                            typeHotel++;
                        } else if (typeLower.includes('centre')) {
                            typeCentre++;
                        } else {
                            typeAutre++;
                        }
                    }
                }
                
                if (colDateDebut !== -1 && colDateFin !== -1) {
                    const dateDebut = parseDate(row[colDateDebut]);
                    const dateFin = parseDate(row[colDateFin]);
                    
                    if (dateDebut && dateFin) {
                        bookingPeriods.push({
                            start: dateDebut,
                            end: new Date(dateFin.getTime() - 24 * 60 * 60 * 1000),
                            rowIndex: index
                        });
                    }
                }
            });
            
            allHotes = Array.from(allHotes).sort();
            allPays = Array.from(allPays).sort();
            allLieux = Array.from(allLieux).sort();
            allHeberges = Array.from(allHeberges).sort();
            allTypes = Array.from(allTypes).sort();
            
            console.log('üë§ H√¥tes extraits:', allHotes.length);
            console.log('üåç Pays extraits:', allPays.length);
            console.log('üìç Lieux extraits:', allLieux.length);
            console.log('üë• Personnes h√©berg√©es extraites:', allHeberges.length);
            console.log('üôè Pri√®res extraites:', allPrieres.length);
            console.log('üìÖ P√©riodes de r√©servation:', bookingPeriods.length);
            console.log('üè† Types d\'h√©bergement:', { typeFamille, typeHotel, typeCentre, typeAutre });
            console.log('üè† Tous les types distincts:', allTypes);
        }
        
        function updateStats() {
            document.getElementById('totalHebergements').textContent = sheetData.length;
            document.getElementById('totalHotes').textContent = allHotes.length;
            document.getElementById('totalPays').textContent = allPays.length;
            document.getElementById('totalLieux').textContent = allLieux.length;
            document.getElementById('totalHeberges').textContent = allHeberges.length;
            document.getElementById('totalFamille').textContent = typeFamille;
            document.getElementById('totalHotel').textContent = typeHotel;
            document.getElementById('totalCentre').textContent = typeCentre;
            document.getElementById('totalAutre').textContent = typeAutre;
            
            // Mettre √† jour les statistiques mobiles
            document.getElementById('totalHebergementsMobile').textContent = sheetData.length;
            document.getElementById('totalHotesMobile').textContent = allHotes.length;
            document.getElementById('totalPaysMobile').textContent = allPays.length;
            document.getElementById('totalLieuxMobile').textContent = allLieux.length;
            document.getElementById('totalHebergesMobile').textContent = allHeberges.length;
            document.getElementById('totalFamilleMobile').textContent = typeFamille;
            document.getElementById('totalHotelMobile').textContent = typeHotel;
            document.getElementById('totalCentreMobile').textContent = typeCentre;
            document.getElementById('totalAutreMobile').textContent = typeAutre;
        }
        
        function renderFilterTags() {
            renderTags('hotesTags', allHotes, 'nom');
            renderTags('paysTags', allPays, 'pays');
            renderTags('lieuxTags', allLieux, 'lieu');
            renderTags('hebergesTags', allHeberges, 'heberge');
            renderTags('typesTags', allTypes, 'type');
        }
        
        function renderMobileFilterTags() {
            renderMobileTags('mobileHotesTags', allHotes, 'nom');
            renderMobileTags('mobilePaysTags', allPays, 'pays');
            renderMobileTags('mobileLieuxTags', allLieux, 'lieu');
            renderMobileTags('mobileHebergesTags', allHeberges, 'heberge');
            renderMobileTags('mobileTypesTags', allTypes, 'type');
        }
        
        function renderTags(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Aucun ' + type + ' trouv√©</div>';
                return;
            }
            
            items.forEach(item => {
                const tag = document.createElement('div');
                tag.className = `tag ${type}`;
                tag.textContent = item;
                
                if (type === 'heberge') {
                    tag.title = `Cliquez pour voir les options pour ${item}`;
                    tag.addEventListener('click', (event) => {
                        event.stopPropagation();
                        event.preventDefault();
                        showPersonOptionsBubble(tag, item);
                    });
                } else if (type === 'type') {
                    tag.title = `Cliquez pour voir les fiches pour le type: ${item}`;
                    tag.addEventListener('click', (event) => {
                        event.stopPropagation();
                        event.preventDefault();
                        filterByType(item);
                    });
                } else {
                    tag.title = `Cliquez pour voir les fiches pour ${item}`;
                    tag.addEventListener('click', (event) => {
                        event.stopPropagation();
                        event.preventDefault();
                        const results = filterDataByType(item, type);
                        displayResults(results, `Fiches pour ${type}: ${item}`);
                    });
                }
                
                container.appendChild(tag);
            });
        }
        
        function renderMobileTags(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = '<div style="color: #7f8c8d; font-style: italic; font-size: 0.9em; padding: 10px; text-align: center;">Aucun ' + type + ' trouv√©</div>';
                return;
            }
            
            items.forEach(item => {
                const tag = document.createElement('div');
                tag.className = `mobile-tag ${type}`;
                tag.textContent = item;
                
                if (type === 'heberge') {
                    tag.title = `Cliquez pour voir les options pour ${item}`;
                    tag.addEventListener('click', (event) => {
                        event.stopPropagation();
                        event.preventDefault();
                        showPersonOptionsBubble(tag, item);
                    });
                } else if (type === 'type') {
                    tag.title = `Cliquez pour voir les fiches pour le type: ${item}`;
                    tag.addEventListener('click', (event) => {
                        event.stopPropagation();
                        event.preventDefault();
                        filterByType(item);
                    });
                } else {
                    tag.title = `Cliquez pour voir les fiches pour ${item}`;
                    tag.addEventListener('click', (event) => {
                        event.stopPropagation();
                        event.preventDefault();
                        const results = filterDataByType(item, type);
                        displayResults(results, `Fiches pour ${type}: ${item}`);
                    });
                }
                
                container.appendChild(tag);
            });
        }
        
        function filterDataByType(value, type) {
            let columnIndex = -1;
            
            switch(type) {
                case 'nom':
                    columnIndex = colNom;
                    break;
                case 'pays':
                    columnIndex = colPays;
                    break;
                case 'lieu':
                    columnIndex = colLieu;
                    break;
                case 'type':
                    columnIndex = colHebergeEn;
                    break;
            }
            
            if (columnIndex === -1) return [];
            
            return sheetData.filter(row => {
                const cellValue = row[columnIndex] || '';
                return cellValue.includes(value);
            });
        }
        
        function filterByHeberge(nom) {
            return sheetData.filter(row => {
                const colonnesPersonnes = [colMpihiraLehilahy, colMpitendry, colFeo1, colFeo2];
                return colonnesPersonnes.some(colIndex => {
                    if (colIndex === -1) return false;
                    const personnes = row[colIndex] || '';
                    return personnes.toLowerCase().includes(nom.toLowerCase());
                });
            });
        }
        
        function showPrieres() {
            if (allPrieres.length === 0) {
                alert('Aucun sujet de pri√®re trouv√©');
                return;
            }
            
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 5px;">
                    <strong>${allPrieres.length} sujet(s) de pri√®re trouv√©(s)</strong>
                </div>
            `;
            
            allPrieres.forEach(priere => {
                html += `
                    <div class="fiche-item">
                        <div class="fiche-header">
                            <h2>üôè Sujet de Pri√®re</h2>
                            <h3 class="fiche-title">${priere.hote}</h3>
                        </div>
                        <div class="priere-section">
                            <div class="priere-content">${priere.priere}</div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('resultContent').innerHTML = html;
            document.getElementById('resultTitle').textContent = 'Sujets de pri√®re';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('tableauSection').style.display = 'none';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthElement = document.getElementById('currentMonth');
            
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
                "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            monthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            grid.innerHTML = '';
            
            ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const today = new Date();
            
            let startDay = firstDay.getDay();
            startDay = startDay === 0 ? 6 : startDay - 1;
            
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }
            
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.textContent = i;
                
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                
                // V√©rifier si c'est aujourd'hui
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    day.classList.add('today');
                }
                
                const isInBookingPeriod = bookingPeriods.some(period => 
                    date >= period.start && date <= period.end
                );
                
                if (isInBookingPeriod) {
                    day.classList.add('booking-period');
                    day.classList.add('has-data');
                    day.title = 'P√©riode de r√©servation d\'h√©bergement - Cliquez pour voir les options';
                }
                
                if (selectedDate && 
                    selectedDate.getDate() === date.getDate() &&
                    selectedDate.getMonth() === date.getMonth() &&
                    selectedDate.getFullYear() === date.getFullYear()) {
                    day.classList.add('selected');
                }
                
                day.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectDate(date);
                });
                
                grid.appendChild(day);
            }
        }
        
        function selectDate(date) {
            selectedDate = date;
            const matchingRows = findEntriesByDate(date);
            displayResults(matchingRows, `H√©bergements pour le ${formatDateForDisplay(date)}`);
            renderCalendar();
            hidePersonBubble();
        }
        
        function findEntriesByDate(date) {
            return sheetData.filter((row, index) => {
                if (colDateDebut === -1 || colDateFin === -1) return false;
                
                const dateDebut = parseDate(row[colDateDebut]);
                const dateFin = parseDate(row[colDateFin]);
                
                if (!dateDebut || !dateFin) return false;
                
                const dateFinMinusOne = new Date(dateFin.getTime() - 24 * 60 * 60 * 1000);
                return date >= dateDebut && date <= dateFinMinusOne;
            });
        }
        
        function parseDate(dateString) {
            if (!dateString) return null;
            
            const formats = [
                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/,
                /^(\d{1,2})-(\d{1,2})-(\d{4})$/
            ];
            
            for (const format of formats) {
                const match = dateString.match(format);
                if (match) {
                    if (format === formats[0]) {
                        return new Date(match[3], match[2] - 1, match[1]);
                    } else if (format === formats[1]) {
                        return new Date(match[1], match[2] - 1, match[3]);
                    } else if (format === formats[2]) {
                        return new Date(match[3], match[2] - 1, match[1]);
                    }
                }
            }
            
            const parsed = Date.parse(dateString);
            if (!isNaN(parsed)) {
                return new Date(parsed);
            }
            
            console.warn('Impossible de parser la date:', dateString);
            return null;
        }
        
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function showDataInfo() {
            const dataInfo = document.getElementById('dataInfo');
            dataInfo.innerHTML = `
                <div class="success-message">
                    ‚úÖ Donn√©es charg√©es avec succ√®s : ${sheetData.length} h√©bergement(s) trouv√©(s)
                    <br><small>${allHotes.length} h√¥tes - ${allPays.length} pays - ${allLieux.length} lieux - ${allHeberges.length} personnes h√©berg√©es</small>
                    <br><small>Types d'h√©bergement: ${typeFamille} Famille, ${typeHotel} H√¥tel, ${typeCentre} Centre, ${typeAutre} Autres</small>
                </div>
            `;
            dataInfo.style.display = 'block';
        }
        
        function showError(message) {
            const searchSection = document.querySelector('.search-section');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <strong>‚ùå Erreur de chargement:</strong> ${message}
                <br><small>V√©rifiez votre connexion internet et que le Google Sheet est public</small>
            `;
            searchSection.appendChild(errorDiv);
        }
        
        function clearErrorMessages() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());
        }
        
        function handleSearch() {
            const dateValue = document.getElementById('dateInput').value;
            
            if (!dateValue) {
                alert('Veuillez s√©lectionner une date');
                return;
            }
            
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            const selectedDate = new Date(dateValue);
            searchByDate(selectedDate);
            hidePersonBubble();
        }
        
        function searchByDate(date) {
            const results = findEntriesByDate(date);
            const formattedDate = formatDateForDisplay(date);
            displayResults(results, `H√©bergements pour le ${formattedDate}`);
            
            scrollToDateInCalendar(date);
        }
        
        function scrollToDateInCalendar(date) {
            if (date.getMonth() !== currentDate.getMonth() || date.getFullYear() !== currentDate.getFullYear()) {
                currentDate = new Date(date.getFullYear(), date.getMonth(), 1);
                renderCalendar();
            }
            
            setTimeout(() => {
                const dayElements = document.querySelectorAll('.calendar-day:not(.other-month)');
                dayElements.forEach(dayElement => {
                    if (parseInt(dayElement.textContent) === date.getDate()) {
                        document.querySelectorAll('.calendar-day.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        
                        dayElement.classList.add('selected');
                        dayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 100);
        }
        
        function showAllData() {
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            displayResults(sheetData, 'Tous les h√©bergements');
            document.getElementById('tableauSection').style.display = 'none';
            hidePersonBubble();
        }
        
        function displayResults(results, title) {
            const resultsSection = document.getElementById('resultsSection');
            const resultContent = document.getElementById('resultContent');
            const resultTitle = document.getElementById('resultTitle');
            
            // Cacher la section du tableau
            document.getElementById('tableauSection').style.display = 'none';
            
            if (results.length === 0) {
                resultContent.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Aucun h√©bergement trouv√©</h3>
                        <p>Aucun h√©bergement ne correspond √† votre recherche</p>
                    </div>
                `;
            } else {
                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 5px;">
                        <strong>${results.length} h√©bergement(s) trouv√©(s)</strong>
                `;
                
                if (currentSelectedPerson) {
                    html += `<br><em>Filtr√© par: ${currentSelectedPerson}</em>`;
                }
                
                html += `</div>`;
                
                results.forEach((row, index) => {
                    const numeroData = sheetData.findIndex(r => r === row) + 1;
                    
                    const dateDebut = colDateDebut !== -1 ? row[colDateDebut] : '';
                    const dateFin = colDateFin !== -1 ? row[colDateFin] : '';
                    const nom = colNom !== -1 ? row[colNom] : '';
                    const pays = colPays !== -1 ? row[colPays] : '';
                    const lieu = colLieu !== -1 ? row[colLieu] : '';
                    const adresse = colAdresse !== -1 ? row[colAdresse] : '';
                    const email = colEmail !== -1 ? row[colEmail] : '';
                    const facebook = colFacebook !== -1 ? row[colFacebook] : '';
                    const telephone = colTelephone !== -1 ? row[colTelephone] : '';
                    const mpihiraLehilahy = colMpihiraLehilahy !== -1 ? row[colMpihiraLehilahy] : '';
                    const mpitendry = colMpitendry !== -1 ? row[colMpitendry] : '';
                    const feo1 = colFeo1 !== -1 ? row[colFeo1] : '';
                    const feo2 = colFeo2 !== -1 ? row[colFeo2] : '';
                    const priere = colPriere !== -1 ? row[colPriere] : '';
                    const marquants = colMarquants !== -1 ? row[colMarquants] : '';
                    const photosHotes = colPhotosHotes !== -1 ? row[colPhotosHotes] : '';
                    const photosLieux = colPhotosLieux !== -1 ? row[colPhotosLieux] : '';
                    const formulaire = colFormulaire !== -1 ? row[colFormulaire] : '';
                    const repartition = colRepartition !== -1 ? row[colRepartition] : '';
                    const type = colHebergeEn !== -1 ? row[colHebergeEn] : '';
                    
                    const adresseHebergeur = colAdresseHebergeur !== -1 ? row[colAdresseHebergeur] : '';
                    const lieuHebergeur = colLieuHebergeur !== -1 ? row[colLieuHebergeur] : '';
                    const paysHebergeur = colPaysHebergeur !== -1 ? row[colPaysHebergeur] : '';
                    const numeroHebergeur = colNumeroHebergeur !== -1 ? row[colNumeroHebergeur] : '';
                    
                    const aSavoirHote = colASavoirHote !== -1 ? row[colASavoirHote] : '';
                    
                    let adresseComplete = adresseHebergeur || adresse || '';
                    if (adresseComplete && lieuHebergeur) {
                        adresseComplete += ` - ${lieuHebergeur}`;
                    }
                    if (adresseComplete && paysHebergeur) {
                        adresseComplete += ` / ${paysHebergeur}`;
                    }
                    
                    let toutesPersonnes = [];
                    const colonnesPersonnes = [
                        {data: mpihiraLehilahy, type: 'Mpihira Lehilahy'},
                        {data: mpitendry, type: 'Mpitendry'},
                        {data: feo1, type: 'Feo 1'},
                        {data: feo2, type: 'Feo 2'}
                    ];
                    
                    colonnesPersonnes.forEach(col => {
                        if (col.data && col.data.trim()) {
                            col.data.split(',').forEach(p => {
                                const trimmed = p.trim();
                                if (trimmed) toutesPersonnes.push(trimmed);
                            });
                        }
                    });
                    
                    let personnesAffichees = '';
                    let personnesPourTags = [];
                    
                    if (repartition && repartition.trim()) {
                        if (repartition.toLowerCase().includes('tout le monde')) {
                            personnesPourTags = Array.from(allHeberges);
                            personnesAffichees = `Tout le monde / ${personnesPourTags.join(', ')}`;
                        } else {
                            personnesPourTags = toutesPersonnes;
                            personnesAffichees = `${repartition} / ${toutesPersonnes.join(', ')}`;
                        }
                    } else {
                        personnesPourTags = toutesPersonnes;
                        personnesAffichees = toutesPersonnes.join(', ');
                    }
                    
                    const titreFiche = `${dateDebut || '?'} - ${dateFin || '?'} / ${personnesPourTags.length > 0 ? personnesPourTags.join(', ') : 'Aucun h√©berg√©'}`;
                    
                    const isMobile = window.innerWidth <= 768;
                    const gridClass = isMobile ? 'info-grid-mobile' : 'info-grid';
                    
                    // Fonction pour rendre les dates cliquables
                    const rendreDateCliquable = (dateStr) => {
                        if (!dateStr || dateStr === 'Non sp√©cifi√©e') return dateStr;
                        const dateObj = parseDate(dateStr);
                        if (dateObj) {
                            return `<span class="date-clickable" onclick="searchByDate(new Date(${dateObj.getTime()}))">${dateStr}</span>`;
                        }
                        return dateStr;
                    };
                    
                    // Fonction pour rendre les lieux/pays cliquables
                    const rendreLocationCliquable = (value, type) => {
                        if (!value || value === 'Non sp√©cifi√©') return value;
                        return `<span class="location-clickable" onclick="filterByLocation('${value.replace(/'/g, "\\'")}', '${type}')">${value}</span>`;
                    };
                    
                    // Fonction pour rendre les personnes h√©berg√©es cliquables
                    const rendreHebergeCliquable = (personName) => {
                        return `<span class="heberge-item-clickable" onclick="showPersonOptionsForHeberge(event, '${personName.replace(/'/g, "\\'")}')">${personName}</span>`;
                    };
                    
                    html += `
                        <div class="fiche-item">
                            <div class="fiche-header">
                                <h2>üè® H√©bergement Tourn√©e 2026</h2>
                                <h3 class="fiche-title">${titreFiche}</h3>
                            </div>
                            
                            <div class="hote-section">
                                <span class="hote-label">üë§ H√©berg√© chez :</span>
                                <div class="hote-name" style="cursor: pointer; text-decoration: underline; color: #27ae60;" onclick="showFichesForHote('${nom.replace(/'/g, "\\'")}')">${nom || 'H√¥te non sp√©cifi√©'}</div>
                            </div>
                            
                            <div class="${gridClass}">
                                <div class="info-item">
                                    <span class="info-label">üìÖ Date d√©but:</span>
                                    <span class="info-value">${rendreDateCliquable(dateDebut) || 'Non sp√©cifi√©e'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">üìÖ Date fin:</span>
                                    <span class="info-value">${rendreDateCliquable(dateFin) || 'Non sp√©cifi√©e'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">üìç Lieu:</span>
                                    <span class="info-value">${rendreLocationCliquable(lieu, 'lieu') || 'Non sp√©cifi√©'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">üåç Pays:</span>
                                    <span class="info-value">${rendreLocationCliquable(pays, 'pays') || 'Non sp√©cifi√©'}</span>
                                </div>
                            </div>
                            
                            ${type ? `
                            <div class="hebergement-type-section">
                                <div class="hebergement-type-label">üè† H√©berg√© en:</div>
                                <div class="hebergement-type-content">${type}</div>
                            </div>
                            ` : ''}
                            
                            ${personnesPourTags.length > 0 ? `
                            <div class="heberges-list">
                                <div class="heberges-label">üë• Les h√©berg√©s:</div>
                                <div class="heberges-tags">
                                    ${personnesPourTags.map(p => rendreHebergeCliquable(p)).join('')}
                                </div>
                                <div style="margin-top: 10px; font-style: italic; color: #666;">
                                    ${personnesAffichees}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${(adresseComplete || email || facebook || telephone || numeroHebergeur) ? `
                            <div class="contact-section">
                                <div class="contact-label">üìû Information sur ${nom || 'l\'h√©bergeur'}:</div>
                                ${adresseComplete ? `<div style="margin-bottom: 8px;"><strong>üìç Adresse:</strong> ${adresseComplete}</div>` : ''}
                                ${numeroHebergeur ? `<div style="margin-bottom: 8px;"><strong>üî¢ Num√©ro:</strong> <span class="phone-clickable" onclick="window.location.href='tel:${numeroHebergeur}'">${numeroHebergeur}</span></div>` : ''}
                                <div style="height: 1px; background: #ddd; margin: 10px 0;"></div>
                                ${email ? `<div style="margin-bottom: 8px;"><strong>üìß Adresse e-mail:</strong> <a href="mailto:${email}" class="contact-link">${email}</a></div>` : ''}
                                ${facebook ? `<div style="margin-bottom: 8px;"><strong>üë• Nom sur Facebook ou autres compte r√©seaux sociaux:</strong> ${facebook}</div>` : ''}
                                ${telephone ? `<div style="margin-bottom: 8px;"><strong>üì± Num√©ro t√©l√©phone/Whatsapp:</strong> <span class="phone-clickable" onclick="window.location.href='tel:${telephone}'">${telephone}</span></div>` : ''}
                            </div>
                            ` : ''}
                            
                            ${aSavoirHote ? `
                            <div class="hote-info-section">
                                <div class="hote-info-label">‚ÑπÔ∏è √Ä savoir sur le h√¥te/l'h√©bergeur:</div>
                                <div class="hote-info-content">${aSavoirHote}</div>
                            </div>
                            ` : ''}
                            
                            ${(photosHotes || photosLieux || formulaire) ? `
                            <div class="links-section">
                                ${photosHotes ? `<a href="${photosHotes}" target="_blank" class="link-button photos-hotes">üì∏ PHOTOS AVEC LES H√îTES</a>` : ''}
                                ${photosLieux ? `<a href="${photosLieux}" target="_blank" class="link-button photos-lieux">üèûÔ∏è PHOTOS DES LIEUX</a>` : ''}
                                ${formulaire ? `<a href="${formulaire}" target="_blank" class="link-button formulaire">üîó LIEN DE CE FORMULAIRE</a>` : ''}
                            </div>
                            ` : ''}
                            
                            ${marquants ? `
                            <div class="marquants-section">
                                <div class="marquants-label">‚≠ê Marquants:</div>
                                <div class="marquants-content">${marquants}</div>
                            </div>
                            ` : ''}
                            
                            ${priere ? `
                            <div class="priere-section">
                                <div class="priere-label">üôè Sujet de pri√®re:</div>
                                <div class="priere-content">${priere}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                resultContent.innerHTML = html;
            }
            
            resultTitle.textContent = `${title} (${results.length} h√©bergement${results.length > 1 ? 's' : ''})`;
            resultsSection.style.display = 'block';
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Cette fonction est appel√©e quand on clique sur un tag de personne h√©berg√©e
        function showPersonOptions(event, personName) {
            event.stopPropagation();
            event.preventDefault();
            showPersonOptionsBubble(event.target, personName);
        }
        
        function closeResults() {
            document.getElementById('resultsSection').style.display = 'none';
            hidePersonBubble();
        }
    </script>
</body>
</html>
